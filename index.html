<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker Pro v3.0 - Ultimate Edition</title>
    
    <!-- PWA Meta Tags f√ºr iOS -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FinanceTracker">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%2310b981;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='192' height='192' rx='40' fill='url(%23grad)'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle' fill='white'%3Eüí∞%3C/text%3E%3C/svg%3E">
    <meta name="theme-color" content="#3b82f6">
    
    <style>
        /* ==================== CSS VARIABLES ==================== */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-info: #06b6d4;
            --border-color: #475569;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.4);
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --accent-primary: #2563eb;
            --accent-success: #059669;
            --accent-warning: #d97706;
            --accent-danger: #dc2626;
            --accent-info: #0891b2;
            --border-color: #cbd5e1;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        /* ==================== HEADER ==================== */
        .header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .header-badge {
            display: inline-block;
            background: var(--accent-success);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--accent-primary);
            transform: scale(1.05);
        }

        /* ==================== NAVIGATION ==================== */
        .nav {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
            scrollbar-width: thin;
        }

        .nav::-webkit-scrollbar {
            height: 6px;
        }

        .nav::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .nav::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 3px;
        }

        .nav-btn {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: var(--accent-primary);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--accent-primary);
            box-shadow: var(--shadow);
        }

        /* ==================== CONTAINER ==================== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== CARDS ==================== */
        .card {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        /* ==================== GRIDS ==================== */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* ==================== STATS CARDS ==================== */
        .stat-card {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .stat-value.positive {
            color: var(--accent-success);
        }

        .stat-value.negative {
            color: var(--accent-danger);
        }

        .stat-value.neutral {
            color: var(--accent-info);
        }

        /* ==================== FORMS ==================== */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-checkbox {
            width: auto;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: var(--accent-success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--accent-warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-info {
            background: var(--accent-info);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
            font-size: 1.1rem;
        }

        .btn-icon:hover {
            background: var(--bg-primary);
            color: var(--accent-primary);
            transform: scale(1.1);
        }

        /* ==================== TRANSACTION ITEMS ==================== */
        .transaction-item {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            position: relative;
        }

        .transaction-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--accent-primary);
            color: white;
            border-radius: 1rem;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .transaction-description {
            font-weight: 500;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .transaction-date {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .transaction-amount {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 1rem;
        }

        .transaction-amount.income {
            color: var(--accent-success);
        }

        .transaction-amount.expense {
            color: var(--accent-danger);
        }

        .transaction-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ==================== BADGES ==================== */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .badge-recurring {
            background: var(--accent-warning);
            color: white;
        }

        .badge-active {
            background: var(--accent-success);
            color: white;
        }

        .badge-paused {
            background: var(--text-muted);
            color: white;
        }

        .badge-template {
            background: var(--accent-info);
            color: white;
        }

        .badge-tag {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* ==================== ALERTS ==================== */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--accent-success);
            color: var(--accent-success);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--accent-warning);
            color: var(--accent-warning);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        .alert-info {
            background: rgba(6, 182, 212, 0.1);
            border-color: var(--accent-info);
            color: var(--accent-info);
        }

        /* ==================== BUDGET PROGRESS ==================== */
        .budget-item {
            margin-bottom: 1.5rem;
        }

        .budget-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .budget-name {
            font-weight: 600;
        }

        .budget-stats {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .budget-progress-bar {
            height: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }

        .budget-progress-fill {
            height: 100%;
            transition: width 0.3s, background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .budget-progress-fill.low {
            background: var(--accent-success);
        }

        .budget-progress-fill.medium {
            background: var(--accent-warning);
        }

        .budget-progress-fill.high {
            background: var(--accent-danger);
        }

        /* ==================== CHARTS ==================== */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }

        /* ==================== MODAL ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.5rem;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--accent-danger);
            transform: scale(1.2);
        }

        /* ==================== EMPTY STATE ==================== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* ==================== FILTERS ==================== */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 180px;
        }

        /* ==================== TOAST ==================== */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.3s ease;
            min-width: 300px;
        }

        .toast.active {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid var(--accent-success);
        }

        .toast.error {
            border-left: 4px solid var(--accent-danger);
        }

        .toast.warning {
            border-left: 4px solid var(--accent-warning);
        }

        .toast.info {
            border-left: 4px solid var(--accent-info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ==================== TAGS ==================== */
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .tag-input-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .tag-input {
            flex: 1;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* ==================== GOALS ==================== */
        .goal-item {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .goal-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .goal-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-success);
        }

        .goal-progress {
            height: 2rem;
            background: var(--bg-secondary);
            border-radius: 1rem;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-success), var(--accent-info));
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .goal-meta {
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* ==================== CALENDAR PREVIEW ==================== */
        .calendar-mini {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            font-size: 0.8rem;
        }

        .calendar-day {
            padding: 0.5rem;
            text-align: center;
            border-radius: 0.25rem;
            background: var(--bg-tertiary);
        }

        .calendar-day.has-transaction {
            background: var(--accent-primary);
            color: white;
            font-weight: 600;
        }

        /* ==================== SUBSCRIPTION TRACKER ==================== */
        .subscription-item {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .subscription-info {
            flex: 1;
        }

        .subscription-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .subscription-meta {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .subscription-warning {
            color: var(--accent-warning);
            font-weight: 600;
        }

        /* ==================== KONTEN ==================== */
        .account-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .account-chip {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .account-chip:hover {
            border-color: var(--accent-primary);
        }

        .account-chip.active {
            background: var(--accent-primary);
            color: white;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .nav {
                padding: 0.5rem 1rem;
                gap: 0.5rem;
            }

            .container {
                padding: 1rem;
            }

            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }

            .transaction-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .transaction-amount {
                margin: 0;
                font-size: 1.5rem;
            }

            .transaction-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .chart-container {
                height: 300px;
            }

            .modal-content {
                padding: 1rem;
            }

            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                min-width: auto;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }
        }

        /* ==================== UTILITIES ==================== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .w-full { width: 100%; }

        /* ==================== LOADING SPINNER ==================== */
        .spinner {
            border: 3px solid var(--bg-tertiary);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ==================== HEADER ==================== -->
    <header class="header">
        <div>
            <h1>üí∞ Finance Tracker Pro <span class="header-badge">v3.0 ULTIMATE</span></h1>
        </div>
        <div class="header-actions">
            <button class="btn btn-sm btn-info" onclick="showQuickAdd()">‚ö° Quick Add</button>
            <button class="btn btn-sm btn-secondary" onclick="openModal('accountsModal')">üí≥ Konten</button>
            <button class="theme-toggle" onclick="toggleTheme()" title="Dark/Light Mode">üåô</button>
            <button class="btn btn-sm btn-primary" onclick="openModal('backupModal')">üíæ Backup</button>
        </div>
    </header>

    <!-- ==================== NAVIGATION ==================== -->
    <nav class="nav">
        <button class="nav-btn active" onclick="switchSection('dashboard')">üìä Dashboard</button>
        <button class="nav-btn" onclick="switchSection('transactions')">üí≥ Transaktionen</button>
        <button class="nav-btn" onclick="switchSection('recurring')">üîÑ Dauerauftr√§ge</button>
        <button class="nav-btn" onclick="switchSection('budgets')">üéØ Budgets</button>
        <button class="nav-btn" onclick="switchSection('goals')">üéñÔ∏è Sparziele</button>
        <button class="nav-btn" onclick="switchSection('subscriptions')">üìÜ Abos</button>
        <button class="nav-btn" onclick="switchSection('analytics')">üìà Analytics</button>
        <button class="nav-btn" onclick="switchSection('immobilien')">üè¢ Immobilien</button>
        <button class="nav-btn" onclick="switchSection('investments')">üíé Investments</button>
        <button class="nav-btn" onclick="switchSection('taxes')">üìã Steuer-Report</button>
        <button class="nav-btn" onclick="switchSection('settings')">‚öôÔ∏è Einstellungen</button>
    </nav>

    <!-- ==================== MAIN CONTAINER ==================== -->
    <div class="container">
        
        <!-- ========== BUDGET WARNINGS (GLOBAL) ========== -->
        <div id="budgetWarnings"></div>

        <!-- ========== DASHBOARD SECTION ========== -->
        <section id="dashboard" class="section active">
            <!-- Account Selector -->
            <div class="card">
                <div class="account-selector" id="accountSelector"></div>
            </div>

            <div class="grid-4">
                <div class="stat-card" onclick="switchSection('transactions')">
                    <div class="stat-label">Aktuelles Guthaben</div>
                    <div class="stat-value" id="totalBalance">0,00 ‚Ç¨</div>
                    <div class="stat-label" style="margin-top: 0.5rem; font-size: 0.8rem;" id="balanceAccount"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Einnahmen (Monat)</div>
                    <div class="stat-value positive" id="monthIncome">0,00 ‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ausgaben (Monat)</div>
                    <div class="stat-value negative" id="monthExpense">0,00 ‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sparquote (Monat)</div>
                    <div class="stat-value" id="monthSavingsRate">0,0%</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">Kontostand-Entwicklung</div>
                    <div class="chart-container">
                        <canvas id="balanceHistoryChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        Ausgaben nach Kategorie
                        <select class="form-select" style="width: auto; padding: 0.5rem;" onchange="loadCategoryChart()" id="categoryChartPeriod">
                            <option value="thisMonth">Dieser Monat</option>
                            <option value="lastMonth">Letzter Monat</option>
                            <option value="thisYear">Dieses Jahr</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">Monatsvergleich</div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">N√§chste f√§llige Transaktionen</div>
                    <div id="upcomingTransactions"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Letzte Transaktionen</div>
                <div id="recentTransactions"></div>
            </div>
        </section>

        <!-- ========== TRANSACTIONS SECTION ========== -->
        <section id="transactions" class="section">
            <div class="card">
                <div class="card-header">
                    Neue Transaktion hinzuf√ºgen
                    <div class="flex gap-1">
                        <button class="btn btn-sm btn-secondary" onclick="openModal('templatesModal')">üìã Vorlagen</button>
                        <button class="btn btn-sm btn-info" onclick="openModal('csvImportModal')">üì• CSV Import</button>
                    </div>
                </div>
                <form id="transactionForm" onsubmit="addTransaction(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Typ</label>
                            <select class="form-select" id="transactionType" required>
                                <option value="expense">Ausgabe</option>
                                <option value="income">Einnahme</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Betrag (‚Ç¨)</label>
                            <input type="number" class="form-input" id="transactionAmount" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kategorie</label>
                            <div class="flex gap-1">
                                <select class="form-select" id="transactionCategory" required style="flex: 1;">
                                    <!-- Wird dynamisch gef√ºllt -->
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="openModal('categoriesModal')" title="Kategorien verwalten">‚öôÔ∏è</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Datum</label>
                            <input type="date" class="form-input" id="transactionDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Beschreibung</label>
                        <input type="text" class="form-input" id="transactionDescription" required placeholder="z.B. Einkauf bei REWE">
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Konto / Wallet</label>
                            <select class="form-select" id="transactionAccount">
                                <!-- Wird dynamisch gef√ºllt -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notiz (optional)</label>
                            <input type="text" class="form-input" id="transactionNote" placeholder="Zus√§tzliche Notiz">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags (optional)</label>
                        <div class="tag-input-container">
                            <input type="text" class="tag-input" id="transactionTags" placeholder="z.B. steuerrelevant, privat (mit Komma trennen)">
                        </div>
                        <div class="tags" id="transactionTagsPreview"></div>
                    </div>
                    <div class="flex gap-1">
                        <button type="submit" class="btn btn-primary btn-block">‚ûï Transaktion hinzuf√ºgen</button>
                        <button type="button" class="btn btn-success" onclick="saveAsTemplate()">üíæ Als Vorlage speichern</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    Alle Transaktionen
                    <button class="btn btn-sm btn-warning" onclick="resetFilters()">üîÑ Filter zur√ºcksetzen</button>
                </div>
                <div class="filters">
                    <div class="filter-group">
                        <label class="form-label">Filter nach Typ</label>
                        <select class="form-select" id="filterType" onchange="filterTransactions()">
                            <option value="all">Alle</option>
                            <option value="income">Nur Einnahmen</option>
                            <option value="expense">Nur Ausgaben</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Filter nach Kategorie</label>
                        <select class="form-select" id="filterCategory" onchange="filterTransactions()">
                            <option value="all">Alle Kategorien</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Zeitraum</label>
                        <select class="form-select" id="filterPeriod" onchange="filterTransactions()">
                            <option value="all">Gesamter Zeitraum</option>
                            <option value="thisMonth">Diesen Monat</option>
                            <option value="lastMonth">Letzter Monat</option>
                            <option value="thisYear">Dieses Jahr</option>
                            <option value="last12">Letzte 12 Monate</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Konto</label>
                        <select class="form-select" id="filterAccount" onchange="filterTransactions()">
                            <option value="all">Alle Konten</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Suche</label>
                        <input type="text" class="form-input" id="searchInput" placeholder="Beschreibung, Tags..." oninput="filterTransactions()">
                    </div>
                </div>
                <div id="transactionsList"></div>
            </div>
        </section>

        <!-- ========== RECURRING SECTION ========== -->
        <section id="recurring" class="section">
            <div class="card">
                <div class="card-header">Neuen Dauerauftrag erstellen</div>
                <form id="recurringForm" onsubmit="addRecurring(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Typ</label>
                            <select class="form-select" id="recurringType" required>
                                <option value="expense">Ausgabe</option>
                                <option value="income">Einnahme</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Betrag (‚Ç¨)</label>
                            <input type="number" class="form-input" id="recurringAmount" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kategorie</label>
                            <select class="form-select" id="recurringCategory" required>
                                <!-- Wird dynamisch gef√ºllt -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Intervall</label>
                            <select class="form-select" id="recurringInterval" required>
                                <option value="daily">T√§glich</option>
                                <option value="weekly">W√∂chentlich</option>
                                <option value="biweekly">Zweiw√∂chentlich</option>
                                <option value="monthly">Monatlich</option>
                                <option value="quarterly">Quartalsweise (alle 3 Monate)</option>
                                <option value="yearly">J√§hrlich</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Startdatum</label>
                            <input type="date" class="form-input" id="recurringStartDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Konto / Wallet</label>
                            <select class="form-select" id="recurringAccount">
                                <!-- Wird dynamisch gef√ºllt -->
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Beschreibung</label>
                        <input type="text" class="form-input" id="recurringDescription" required placeholder="z.B. Gehalt, Miete, Strom">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Endet</label>
                        <select class="form-select" id="recurringEndType" onchange="toggleRecurringEndOptions()">
                            <option value="never">Nie</option>
                            <option value="date">An einem bestimmten Datum</option>
                            <option value="count">Nach X Wiederholungen</option>
                        </select>
                    </div>
                    <div class="form-group" id="recurringEndDateGroup" style="display: none;">
                        <label class="form-label">Enddatum</label>
                        <input type="date" class="form-input" id="recurringEndDate">
                    </div>
                    <div class="form-group" id="recurringEndCountGroup" style="display: none;">
                        <label class="form-label">Anzahl Wiederholungen</label>
                        <input type="number" class="form-input" id="recurringEndCount" min="1" placeholder="z.B. 12">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">üîÑ Dauerauftrag erstellen</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    Meine Dauerauftr√§ge
                    <button class="btn btn-success" onclick="previewRecurringGeneration()">
                        ‚ö° F√§llige Transaktionen generieren
                    </button>
                </div>
                <div id="recurringList"></div>
            </div>
        </section>

        <!-- ========== BUDGETS SECTION ========== -->
        <section id="budgets" class="section">
            <div class="card">
                <div class="card-header">Neues Budget erstellen</div>
                <form id="budgetForm" onsubmit="addBudget(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Kategorie</label>
                            <select class="form-select" id="budgetCategory" required>
                                <!-- Wird dynamisch gef√ºllt -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monatliches Limit (‚Ç¨)</label>
                            <input type="number" class="form-input" id="budgetLimit" step="0.01" required placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" class="form-checkbox" id="budgetNotifications">
                            Benachrichtigungen aktivieren (bei 80%, 90%, 100%)
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">‚ûï Budget hinzuf√ºgen</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">Aktuelle Budgets</div>
                <div id="budgetsList"></div>
            </div>
        </section>

        <!-- ========== GOALS SECTION (NEU) ========== -->
        <section id="goals" class="section">
            <div class="card">
                <div class="card-header">Neues Sparziel erstellen</div>
                <form id="goalForm" onsubmit="addGoal(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Ziel-Name</label>
                            <input type="text" class="form-input" id="goalName" required placeholder="z.B. Notgroschen, Urlaub, Auto">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ziel-Betrag (‚Ç¨)</label>
                            <input type="number" class="form-input" id="goalTarget" step="0.01" required placeholder="10000.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Aktueller Betrag (‚Ç¨)</label>
                            <input type="number" class="form-input" id="goalCurrent" step="0.01" value="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ziel-Datum (optional)</label>
                            <input type="date" class="form-input" id="goalDeadline">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notiz</label>
                        <textarea class="form-textarea" id="goalNote" placeholder="Wof√ºr sparst du?"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">üéñÔ∏è Sparziel erstellen</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">Meine Sparziele</div>
                <div id="goalsList"></div>
            </div>
        </section>

        <!-- ========== SUBSCRIPTIONS SECTION (NEU) ========== -->
        <section id="subscriptions" class="section">
            <div class="card">
                <div class="card-header">Neues Abo hinzuf√ºgen</div>
                <form id="subscriptionForm" onsubmit="addSubscription(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-input" id="subscriptionName" required placeholder="z.B. Netflix, Spotify">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monatliche Kosten (‚Ç¨)</label>
                            <input type="number" class="form-input" id="subscriptionCost" step="0.01" required placeholder="9.99">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kategorie</label>
                            <select class="form-select" id="subscriptionCategory" required>
                                <option value="Streaming">üì∫ Streaming</option>
                                <option value="Software">üíª Software</option>
                                <option value="Cloud">‚òÅÔ∏è Cloud-Speicher</option>
                                <option value="Fitness">üèãÔ∏è Fitness</option>
                                <option value="Versicherung">üõ°Ô∏è Versicherung</option>
                                <option value="Sonstiges">üì¶ Sonstiges</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Verl√§ngerung</label>
                            <select class="form-select" id="subscriptionRenewal" required>
                                <option value="monthly">Monatlich</option>
                                <option value="quarterly">Quartalsweise</option>
                                <option value="yearly">J√§hrlich</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√§chste Abrechnung</label>
                            <input type="date" class="form-input" id="subscriptionNextDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">K√ºndigungsfrist (Tage)</label>
                            <input type="number" class="form-input" id="subscriptionCancellation" value="30" placeholder="30">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" class="form-checkbox" id="subscriptionReminder">
                            Erinnerung vor Verl√§ngerung aktivieren
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">üìÜ Abo hinzuf√ºgen</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    Meine Abos
                    <div class="stat-value" style="font-size: 1.2rem;" id="subscriptionTotal">0,00 ‚Ç¨/Monat</div>
                </div>
                <div id="subscriptionsList"></div>
            </div>
        </section>
        <!-- ========== ANALYTICS SECTION ========== -->
        <section id="analytics" class="section">
            <div class="card">
                <div class="card-header">Jahres√ºbersicht</div>
                <div class="chart-container">
                    <canvas id="yearlyChart"></canvas>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">Top Ausgaben-Kategorien</div>
                    <div id="topCategories"></div>
                </div>
                <div class="card">
                    <div class="card-header">Sparquote (Verlauf)</div>
                    <div class="chart-container">
                        <canvas id="savingsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">Ausgaben nach Wochentag (Heatmap)</div>
                    <div class="chart-container">
                        <canvas id="weekdayChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Vergleich zum Vorjahr</div>
                    <div class="chart-container">
                        <canvas id="yearComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== IMMOBILIEN SECTION ========== -->
        <section id="immobilien" class="section">
            <div class="card">
                <div class="card-header">Neues Immobilienobjekt hinzuf√ºgen</div>
                <form id="immobilienForm" onsubmit="addImmobilie(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Objektname</label>
                            <input type="text" class="form-input" id="immobilienName" required placeholder="z.B. Wohnung Musterstra√üe 15">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Adresse</label>
                            <input type="text" class="form-input" id="immobilienAdresse" required placeholder="Stra√üe, PLZ, Stadt">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kaufpreis (‚Ç¨)</label>
                            <input type="number" class="form-input" id="immobilienKaufpreis" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monatliche Kaltmiete (‚Ç¨)</label>
                            <input type="number" class="form-input" id="immobilienMiete" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anzahl Wohneinheiten</label>
                            <input type="number" class="form-input" id="immobilienWohneinheiten" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kaufdatum</label>
                            <input type="date" class="form-input" id="immobilienKaufdatum" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">üè¢ Immobilie hinzuf√ºgen</button>
                </form>
            </div>

            <!-- Kreditrechner (NEU) -->
            <div class="card">
                <div class="card-header">üí∞ Kreditrechner</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Kaufpreis (‚Ç¨)</label>
                        <input type="number" class="form-input" id="calcKaufpreis" step="0.01" placeholder="250000" oninput="calculateLoan()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eigenkapital (‚Ç¨)</label>
                        <input type="number" class="form-input" id="calcEigenkapital" step="0.01" placeholder="50000" oninput="calculateLoan()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zinssatz (%)</label>
                        <input type="number" class="form-input" id="calcZinssatz" step="0.01" placeholder="3.5" oninput="calculateLoan()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Laufzeit (Jahre)</label>
                        <input type="number" class="form-input" id="calcLaufzeit" placeholder="25" oninput="calculateLoan()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monatliche Miete (‚Ç¨)</label>
                        <input type="number" class="form-input" id="calcMiete" step="0.01" placeholder="800" oninput="calculateLoan()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">KfW-F√∂rderung (‚Ç¨)</label>
                        <input type="number" class="form-input" id="calcKfW" step="0.01" value="0" placeholder="0" oninput="calculateLoan()">
                    </div>
                </div>
                <div class="alert alert-info" id="loanResult">
                    <div>
                        <strong>Ergebnis:</strong> Geben Sie die Werte ein, um die Berechnung zu starten.
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">Meine Immobilien</div>
                    <div id="immobilienListe"></div>
                </div>
                <div class="card">
                    <div class="card-header">Portfolio-√úbersicht</div>
                    <div class="grid-3">
                        <div class="stat-card">
                            <div class="stat-label">Gesamtwert</div>
                            <div class="stat-value" id="portfolioWert">0,00 ‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Monatliche Mieten (Soll)</div>
                            <div class="stat-value positive" id="portfolioMieten">0,00 ‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">√ò Rendite</div>
                            <div class="stat-value" id="portfolioRendite">0,0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Netto-Cashflow (Monat)</div>
                            <div class="stat-value" id="portfolioCashflow">0,00 ‚Ç¨</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Mieteinnahmen & Nebenkosten erfassen</div>
                <form id="immobilienTransactionForm" onsubmit="addImmobilienTransaction(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Immobilie ausw√§hlen</label>
                            <select class="form-select" id="immobilienSelect" required>
                                <option value="">-- Bitte w√§hlen --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Typ</label>
                            <select class="form-select" id="immobilienTransactionType" required onchange="updateImmobilienCategories()">
                                <option value="income">Einnahme</option>
                                <option value="expense">Ausgabe</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kategorie</label>
                            <select class="form-select" id="immobilienCategory" required>
                                <option value="Miete">üí∞ Mieteinnahme</option>
                                <option value="Nebenkosten-Nachzahlung">üí∏ Nebenkosten-Nachzahlung</option>
                                <option value="Kaution">üîí Kaution</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Betrag (‚Ç¨)</label>
                            <input type="number" class="form-input" id="immobilienAmount" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Datum</label>
                            <input type="date" class="form-input" id="immobilienTransactionDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mieter/Beschreibung</label>
                            <input type="text" class="form-input" id="immobilienDescription" required placeholder="z.B. Mieter: Max Mustermann">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">‚ûï Erfassen</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">Transaktionshistorie</div>
                <div class="filters">
                    <div class="filter-group">
                        <label class="form-label">Filter nach Immobilie</label>
                        <select class="form-select" id="filterImmobilie" onchange="filterImmobilienTransactions()">
                            <option value="all">Alle Immobilien</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Filter nach Typ</label>
                        <select class="form-select" id="filterImmobilienType" onchange="filterImmobilienTransactions()">
                            <option value="all">Alle</option>
                            <option value="income">Nur Einnahmen</option>
                            <option value="expense">Nur Ausgaben</option>
                        </select>
                    </div>
                </div>
                <div id="immobilienTransactionsList"></div>
            </div>
        </section>

        <!-- ========== INVESTMENTS SECTION ========== -->
        <section id="investments" class="section">
            <div class="card">
                <div class="card-header">Neues Investment hinzuf√ºgen</div>
                <form id="investmentForm" onsubmit="addInvestment(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Typ</label>
                            <select class="form-select" id="investmentType" required>
                                <option value="Aktie">üìà Aktie</option>
                                <option value="ETF">üìä ETF</option>
                                <option value="Fonds">üíº Fonds</option>
                                <option value="Krypto">‚Çø Kryptow√§hrung</option>
                                <option value="Anleihe">üìú Anleihe</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Name / Ticker</label>
                            <input type="text" class="form-input" id="investmentName" required placeholder="z.B. Apple Inc. (AAPL)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ISIN / Symbol</label>
                            <input type="text" class="form-input" id="investmentISIN" placeholder="z.B. US0378331005">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anzahl</label>
                            <input type="number" class="form-input" id="investmentQuantity" step="0.001" required placeholder="0.000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kaufpreis pro Einheit (‚Ç¨)</label>
                            <input type="number" class="form-input" id="investmentBuyPrice" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kaufdatum</label>
                            <input type="date" class="form-input" id="investmentBuyDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Broker / Depot</label>
                            <input type="text" class="form-input" id="investmentBroker" placeholder="z.B. Trade Republic, ING">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Geb√ºhren (‚Ç¨)</label>
                            <input type="number" class="form-input" id="investmentFees" step="0.01" value="0" placeholder="0.00">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">üíé Investment hinzuf√ºgen</button>
                </form>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">Portfolio-√úbersicht</div>
                    <div class="grid-3">
                        <div class="stat-card">
                            <div class="stat-label">Gesamtwert</div>
                            <div class="stat-value" id="portfolioValue">0,00 ‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Investiert</div>
                            <div class="stat-value" id="portfolioInvested">0,00 ‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Gewinn/Verlust</div>
                            <div class="stat-value" id="portfolioProfit">0,00 ‚Ç¨</div>
                        </div>
                    </div>
                    <div class="grid-3" style="margin-top: 1rem;">
                        <div class="stat-card">
                            <div class="stat-label">Performance</div>
                            <div class="stat-value" id="portfolioPerformance">0,0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Dividenden (Jahr)</div>
                            <div class="stat-value positive" id="portfolioDividends">0,00 ‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Anzahl Positionen</div>
                            <div class="stat-value" id="portfolioPositions">0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Asset Allocation</div>
                    <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Aktuellen Kurs aktualisieren</div>
                <form id="priceUpdateForm" onsubmit="updatePrice(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Investment ausw√§hlen</label>
                            <select class="form-select" id="priceUpdateSelect" required>
                                <option value="">-- Bitte w√§hlen --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Aktueller Kurs (‚Ç¨)</label>
                            <input type="number" class="form-input" id="currentPrice" step="0.01" required placeholder="0.00">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">üíπ Kurs aktualisieren</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">Meine Investments</div>
                <div class="filters">
                    <div class="filter-group">
                        <label class="form-label">Filter nach Typ</label>
                        <select class="form-select" id="filterInvestmentType" onchange="filterInvestments()">
                            <option value="all">Alle Typen</option>
                            <option value="Aktie">Aktien</option>
                            <option value="ETF">ETFs</option>
                            <option value="Fonds">Fonds</option>
                            <option value="Krypto">Krypto</option>
                            <option value="Anleihe">Anleihen</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Sortierung</label>
                        <select class="form-select" id="sortInvestments" onchange="filterInvestments()">
                            <option value="value">Nach Wert</option>
                            <option value="performance">Nach Performance</option>
                            <option value="name">Nach Name</option>
                            <option value="date">Nach Kaufdatum</option>
                        </select>
                    </div>
                </div>
                <div id="investmentsList"></div>
            </div>

            <div class="card">
                <div class="card-header">Dividende erfassen</div>
                <form id="dividendForm" onsubmit="addDividend(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Investment ausw√§hlen</label>
                            <select class="form-select" id="dividendInvestmentSelect" required>
                                <option value="">-- Bitte w√§hlen --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Betrag (‚Ç¨)</label>
                            <input type="number" class="form-input" id="dividendAmount" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Datum</label>
                            <input type="date" class="form-input" id="dividendDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Beschreibung</label>
                            <input type="text" class="form-input" id="dividendDescription" placeholder="z.B. Q1 2026 Dividende">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">üí∞ Dividende hinzuf√ºgen</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">Dividenden-Historie</div>
                <div id="dividendsList"></div>
            </div>

            <div class="card">
                <div class="card-header">Portfolio-Performance</div>
                <div class="chart-container">
                    <canvas id="portfolioPerformanceChart"></canvas>
                </div>
            </div>
        </section>

        <!-- ========== TAXES SECTION (NEU) ========== -->
        <section id="taxes" class="section">
            <div class="card">
                <div class="card-header">
                    üìã Steuer-Report Generator
                    <button class="btn btn-success" onclick="generateTaxReport()">üìÑ PDF generieren</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Steuerjahr w√§hlen</label>
                    <select class="form-select" id="taxYear" onchange="loadTaxReport()">
                        <!-- Wird dynamisch gef√ºllt -->
                    </select>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">Mieteinnahmen (Immobilien)</div>
                        <div class="stat-card">
                            <div class="stat-label">Gesamt-Einnahmen</div>
                            <div class="stat-value positive" id="taxRentalIncome">0,00 ‚Ç¨</div>
                        </div>
                        <div id="taxRentalDetails"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">Werbungskosten (Immobilien)</div>
                        <div class="stat-card">
                            <div class="stat-label">Gesamt-Ausgaben</div>
                            <div class="stat-value negative" id="taxRentalExpenses">0,00 ‚Ç¨</div>
                        </div>
                        <div id="taxRentalExpensesDetails"></div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">Kapitalertr√§ge (Investments)</div>
                        <div class="stat-card">
                            <div class="stat-label">Realisierte Gewinne/Verluste</div>
                            <div class="stat-value" id="taxCapitalGains">0,00 ‚Ç¨</div>
                        </div>
                        <div class="stat-card" style="margin-top: 1rem;">
                            <div class="stat-label">Dividenden</div>
                            <div class="stat-value positive" id="taxDividends">0,00 ‚Ç¨</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Zusammenfassung</div>
                        <div class="alert alert-info">
                            <div id="taxSummary">
                                <strong>Hinweis:</strong> Diese √úbersicht dient als Orientierung. Bitte konsultieren Sie einen Steuerberater f√ºr die finale Steuererkl√§rung.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== SETTINGS SECTION ========== -->
        <section id="settings" class="section">
            <div class="card">
                <div class="card-header">Daten-Management</div>
                <div class="grid-2">
                    <button class="btn btn-primary" onclick="exportData()">üì• Daten exportieren (JSON)</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Daten importieren</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn btn-primary" onclick="exportImmobilienCSV()">üìä Immobilien-Report (CSV)</button>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Alle Daten l√∂schen</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Kategorien verwalten</div>
                <div id="categoriesList"></div>
                <button class="btn btn-primary btn-block" onclick="openModal('addCategoryModal')">‚ûï Neue Kategorie hinzuf√ºgen</button>
            </div>

            <div class="card">
                <div class="card-header">Konten verwalten</div>
                <div id="accountsList"></div>
                <button class="btn btn-primary btn-block" onclick="openModal('addAccountModal')">‚ûï Neues Konto hinzuf√ºgen</button>
            </div>

            <div class="card">
                <div class="card-header">√úber Finance Tracker Pro</div>
                <p style="color: var(--text-secondary); line-height: 1.8;">
                    <strong>Version:</strong> 3.0.0 Ultimate Edition<br>
                    <strong>Status:</strong> Produktionsreif<br>
                    <strong>Datenspeicherung:</strong> 100% lokal im Browser (IndexedDB)<br>
                    <strong>Datenschutz:</strong> Keine Cloud, keine externen Server<br>
                    <strong>Features:</strong><br>
                    ‚Ä¢ Transaktionen mit Tags & Notizen<br>
                    ‚Ä¢ Wiederkehrende Transaktionen (Dauerauftr√§ge)<br>
                    ‚Ä¢ Multi-Konten-Verwaltung<br>
                    ‚Ä¢ Budgets mit Benachrichtigungen<br>
                    ‚Ä¢ Sparziele mit Progress-Tracking<br>
                    ‚Ä¢ Abo-Verwaltung mit K√ºndigungsfristen<br>
                    ‚Ä¢ Erweiterte Analytics (Heatmaps, Vergleiche)<br>
                    ‚Ä¢ Immobilien mit Kreditrechner & Cashflow<br>
                    ‚Ä¢ Investment-Portfolio mit Dividenden<br>
                    ‚Ä¢ Steuer-Report Generator<br>
                    ‚Ä¢ CSV-Import von Banken<br>
                    ‚Ä¢ Quick-Add Templates<br>
                    <strong>Export-Formate:</strong> JSON (Vollst√§ndiges Backup), CSV (Immobilien-Report), PDF (Steuer-Report)
                </p>
            </div>
        </section>
    </div>

    <!-- ==================== MODALS ==================== -->
    
    <!-- Backup Modal -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Backup & Wiederherstellung</span>
                <span class="modal-close" onclick="closeModal('backupModal')">&times;</span>
            </div>
            <button class="btn btn-success btn-block" onclick="createBackup()">üíæ Backup jetzt erstellen</button>
            <hr style="margin: 1.5rem 0; border-color: var(--border-color);">
            <button class="btn btn-secondary btn-block" onclick="document.getElementById('restoreFile').click()">‚ôªÔ∏è Backup wiederherstellen</button>
            <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreBackup(event)">
            <p style="margin-top: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                üí° Tipp: Erstelle w√∂chentlich ein Backup und speichere es sicher auf einer externen Festplatte oder Cloud.
            </p>
        </div>
    </div>

    <!-- Recurring Generation Preview Modal -->
    <div id="recurringPreviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>‚ö° F√§llige Transaktionen generieren</span>
                <span class="modal-close" onclick="closeModal('recurringPreviewModal')">&times;</span>
            </div>
            <div id="recurringPreviewList"></div>
            <div class="flex gap-1 mt-2">
                <button class="btn btn-success btn-block" onclick="confirmRecurringGeneration()">‚úì Alle generieren</button>
                <button class="btn btn-secondary btn-block" onclick="closeModal('recurringPreviewModal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Categories Modal -->
    <div id="categoriesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Kategorien verwalten</span>
                <span class="modal-close" onclick="closeModal('categoriesModal')">&times;</span>
            </div>
            <div id="categoriesModalList"></div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Neue Kategorie hinzuf√ºgen</span>
                <span class="modal-close" onclick="closeModal('addCategoryModal')">&times;</span>
            </div>
            <form onsubmit="addCategory(event)">
                <div class="form-group">
                    <label class="form-label">Kategorie-Name</label>
                    <input type="text" class="form-input" id="newCategoryName" required placeholder="z.B. Sport">
                </div>
                <div class="form-group">
                    <label class="form-label">Icon (Emoji)</label>
                    <input type="text" class="form-input" id="newCategoryIcon" required placeholder="‚öΩ" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">Typ</label>
                    <select class="form-select" id="newCategoryType" required>
                        <option value="both">Einnahme & Ausgabe</option>
                        <option value="expense">Nur Ausgabe</option>
                        <option value="income">Nur Einnahme</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-block">‚ûï Kategorie hinzuf√ºgen</button>
            </form>
        </div>
    </div>

    <!-- Accounts Modal -->
    <div id="accountsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Konten verwalten</span>
                <span class="modal-close" onclick="closeModal('accountsModal')">&times;</span>
            </div>
            <div id="accountsModalList"></div>
            <button class="btn btn-primary btn-block mt-2" onclick="closeModal('accountsModal'); openModal('addAccountModal')">‚ûï Neues Konto hinzuf√ºgen</button>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Neues Konto hinzuf√ºgen</span>
                <span class="modal-close" onclick="closeModal('addAccountModal')">&times;</span>
            </div>
            <form onsubmit="addAccount(event)">
                <div class="form-group">
                    <label class="form-label">Konto-Name</label>
                    <input type="text" class="form-input" id="newAccountName" required placeholder="z.B. ING Giro, Visa, Bar">
                </div>
                <div class="form-group">
                    <label class="form-label">Icon (Emoji)</label>
                    <input type="text" class="form-input" id="newAccountIcon" placeholder="üí≥" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">Anfangssaldo (‚Ç¨)</label>
                    <input type="number" class="form-input" id="newAccountBalance" step="0.01" value="0" placeholder="0.00">
                </div>
                <button type="submit" class="btn btn-primary btn-block">‚ûï Konto hinzuf√ºgen</button>
            </form>
        </div>
    </div>

    <!-- Templates Modal -->
    <div id="templatesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üìã Transaktions-Vorlagen</span>
                <span class="modal-close" onclick="closeModal('templatesModal')">&times;</span>
            </div>
            <div id="templatesList"></div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="csvImportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üì• CSV Import</span>
                <span class="modal-close" onclick="closeModal('csvImportModal')">&times;</span>
            </div>
            <div class="form-group">
                <label class="form-label">CSV-Datei hochladen</label>
                <input type="file" class="form-input" id="csvFile" accept=".csv" onchange="previewCSV(event)">
            </div>
            <div id="csvPreview"></div>
            <button class="btn btn-success btn-block" onclick="importCSV()" id="importCSVBtn" style="display:none;">‚úì Transaktionen importieren</button>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>‚ö° Quick Add</span>
                <span class="modal-close" onclick="closeModal('quickAddModal')">&times;</span>
            </div>
            <form onsubmit="quickAddTransaction(event)">
                <div class="form-group">
                    <label class="form-label">Betrag (‚Ç¨)</label>
                    <input type="number" class="form-input" id="quickAmount" step="0.01" required autofocus placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <input type="text" class="form-input" id="quickDescription" required placeholder="Was?">
                </div>
                <div class="flex gap-1">
                    <button type="submit" name="type" value="expense" class="btn btn-danger btn-block">üí∏ Ausgabe</button>
                    <button type="submit" name="type" value="income" class="btn btn-success btn-block">üí∞ Einnahme</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==================== TOAST ==================== -->
    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- ==================== CHART.JS LIBRARY ==================== -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // ==================== GLOBALE VARIABLEN ====================
        let db;
        const DB_NAME = 'FinanceTrackerDB';
        const DB_VERSION = 3; // Version 3 f√ºr neue Features

        let editingTransactionId = null;
        let editingRecurringId = null;
        let editingImmobilieId = null;
        let editingImmobilienTransactionId = null;
        let editingInvestmentId = null;
        let editingDividendId = null;
        let editingGoalId = null;
        let editingSubscriptionId = null;

        // Aktuell ausgew√§hltes Konto
        let selectedAccount = 'all';

        // Chart-Instanzen
        let categoryChart, trendChart, yearlyChart, savingsChart, weekdayChart, yearComparisonChart;
        let allocationChart, portfolioPerformanceChart, balanceHistoryChart;

        // Standard-Kategorien
        const DEFAULT_CATEGORIES = [
            { name: 'Lebensmittel', icon: 'üõí', type: 'expense' },
            { name: 'Transport', icon: 'üöó', type: 'expense' },
            { name: 'Wohnen', icon: 'üè†', type: 'expense' },
            { name: 'Gesundheit', icon: '‚öïÔ∏è', type: 'expense' },
            { name: 'Unterhaltung', icon: 'üé¨', type: 'expense' },
            { name: 'Versicherungen', icon: 'üõ°Ô∏è', type: 'expense' },
            { name: 'Gehalt', icon: 'üíº', type: 'income' },
            { name: 'Mieteinnahmen', icon: 'üè¢', type: 'income' },
            { name: 'Sonstiges', icon: 'üì¶', type: 'both' }
        ];

        // Standard-Konten
        const DEFAULT_ACCOUNTS = [
            { name: 'Girokonto', icon: 'üí≥', balance: 0 },
            { name: 'Bargeld', icon: 'üíµ', balance: 0 }
        ];

        // CSV-Import-Daten (Zwischenspeicher)
        let csvImportData = [];
        // ==================== DATABASE INITIALIZATION ====================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    // Transactions Store
                    if (!db.objectStoreNames.contains('transactions')) {
                        const transactionStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        transactionStore.createIndex('date', 'date', { unique: false });
                        transactionStore.createIndex('category', 'category', { unique: false });
                        transactionStore.createIndex('type', 'type', { unique: false });
                        transactionStore.createIndex('account', 'account', { unique: false });
                    }

                    // Recurring Transactions Store
                    if (!db.objectStoreNames.contains('recurring')) {
                        const recurringStore = db.createObjectStore('recurring', { keyPath: 'id', autoIncrement: true });
                        recurringStore.createIndex('frequency', 'frequency', { unique: false });
                        recurringStore.createIndex('active', 'active', { unique: false });
                    }

                    // Budgets Store
                    if (!db.objectStoreNames.contains('budgets')) {
                        const budgetStore = db.createObjectStore('budgets', { keyPath: 'id', autoIncrement: true });
                        budgetStore.createIndex('category', 'category', { unique: true });
                    }

                    // Goals Store (NEU)
                    if (!db.objectStoreNames.contains('goals')) {
                        db.createObjectStore('goals', { keyPath: 'id', autoIncrement: true });
                    }

                    // Subscriptions Store (NEU)
                    if (!db.objectStoreNames.contains('subscriptions')) {
                        db.createObjectStore('subscriptions', { keyPath: 'id', autoIncrement: true });
                    }

                    // Categories Store (NEU)
                    if (!db.objectStoreNames.contains('categories')) {
                        db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    }

                    // Accounts Store (NEU)
                    if (!db.objectStoreNames.contains('accounts')) {
                        db.createObjectStore('accounts', { keyPath: 'id', autoIncrement: true });
                    }

                    // Templates Store (NEU)
                    if (!db.objectStoreNames.contains('templates')) {
                        db.createObjectStore('templates', { keyPath: 'id', autoIncrement: true });
                    }

                    // Immobilien Store
                    if (!db.objectStoreNames.contains('immobilien')) {
                        const immobilienStore = db.createObjectStore('immobilien', { keyPath: 'id', autoIncrement: true });
                        immobilienStore.createIndex('name', 'name', { unique: false });
                    }

                    // Immobilien Transactions Store
                    if (!db.objectStoreNames.contains('immobilienTransactions')) {
                        const immobilienTransStore = db.createObjectStore('immobilienTransactions', { keyPath: 'id', autoIncrement: true });
                        immobilienTransStore.createIndex('immobilienId', 'immobilienId', { unique: false });
                        immobilienTransStore.createIndex('date', 'date', { unique: false });
                        immobilienTransStore.createIndex('type', 'type', { unique: false });
                    }

                    // Investments Store
                    if (!db.objectStoreNames.contains('investments')) {
                        const investmentStore = db.createObjectStore('investments', { keyPath: 'id', autoIncrement: true });
                        investmentStore.createIndex('type', 'type', { unique: false });
                        investmentStore.createIndex('name', 'name', { unique: false });
                    }

                    // Dividends Store
                    if (!db.objectStoreNames.contains('dividends')) {
                        const dividendStore = db.createObjectStore('dividends', { keyPath: 'id', autoIncrement: true });
                        dividendStore.createIndex('investmentId', 'investmentId', { unique: false });
                        dividendStore.createIndex('date', 'date', { unique: false });
                    }
                };
            });
        }

        // ==================== GENERIC DB OPERATIONS ====================
        function addToStore(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllFromStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateInStore(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFromStore(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateFormat('de-DE').format(date);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type} active`;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // ==================== DATE MATH HELPERS ====================
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function addWeeks(date, weeks) {
            return addDays(date, weeks * 7);
        }

        function addMonths(date, months) {
            const result = new Date(date);
            result.setMonth(result.getMonth() + months);
            return result;
        }

        function addYears(date, years) {
            const result = new Date(date);
            result.setFullYear(result.getFullYear() + years);
            return result;
        }

        function dateToString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isSameDate(date1, date2) {
            return dateToString(date1) === dateToString(date2);
        }

        // ==================== NAVIGATION ====================
        function switchSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            // Daten laden je nach Section
            if (sectionId === 'dashboard') {
                loadDashboard();
            } else if (sectionId === 'transactions') {
                loadTransactions();
                populateCategoryFilter();
                populateAccountFilter();
            } else if (sectionId === 'recurring') {
                loadRecurringTransactions();
            } else if (sectionId === 'budgets') {
                loadBudgets();
            } else if (sectionId === 'goals') {
                loadGoals();
            } else if (sectionId === 'subscriptions') {
                loadSubscriptions();
            } else if (sectionId === 'analytics') {
                loadAnalytics();
            } else if (sectionId === 'immobilien') {
                loadImmobilien();
                loadImmobilienTransactions();
                updateImmobilienSelects();
            } else if (sectionId === 'investments') {
                loadInvestments();
                loadDividends();
                updateInvestmentSelects();
            } else if (sectionId === 'taxes') {
                loadTaxReport();
            } else if (sectionId === 'settings') {
                loadCategories();
                loadAccounts();
            }
        }

        // ==================== THEME TOGGLE ====================
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            
            localStorage.setItem('theme', newTheme);

            // Charts neu laden
            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                const sectionId = activeSection.id;
                if (sectionId === 'dashboard') loadDashboard();
                else if (sectionId === 'analytics') loadAnalytics();
                else if (sectionId === 'investments') loadInvestments();
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            
            // Spezielle Modal-Initialisierungen
            if (modalId === 'categoriesModal') {
                loadCategoriesModal();
            } else if (modalId === 'accountsModal') {
                loadAccountsModal();
            } else if (modalId === 'templatesModal') {
                loadTemplates();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ==================== CATEGORIES MANAGEMENT ====================
        async function initializeCategories() {
            const categories = await getAllFromStore('categories');
            if (categories.length === 0) {
                for (const cat of DEFAULT_CATEGORIES) {
                    await addToStore('categories', cat);
                }
            }
        }

        async function loadCategories() {
            const categories = await getAllFromStore('categories');
            const container = document.getElementById('categoriesList');
            
            if (categories.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Keine Kategorien vorhanden</p></div>';
                return;
            }

            container.innerHTML = categories.map(cat => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-description">${cat.icon} ${cat.name}</div>
                        <div class="transaction-date">Typ: ${cat.type === 'both' ? 'Beide' : cat.type === 'income' ? 'Einnahme' : 'Ausgabe'}</div>
                    </div>
                    <div class="transaction-actions">
                        <button class="btn-icon" onclick="deleteCategory(${cat.id})" title="L√∂schen">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadCategoriesModal() {
            const categories = await getAllFromStore('categories');
            const container = document.getElementById('categoriesModalList');
            
            container.innerHTML = categories.map(cat => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-description">${cat.icon} ${cat.name}</div>
                    </div>
                </div>
            `).join('');
        }

        async function addCategory(event) {
            event.preventDefault();

            const category = {
                name: document.getElementById('newCategoryName').value,
                icon: document.getElementById('newCategoryIcon').value,
                type: document.getElementById('newCategoryType').value
            };

            try {
                await addToStore('categories', category);
                showToast('Kategorie erfolgreich hinzugef√ºgt!', 'success');
                closeModal('addCategoryModal');
                document.querySelector('#addCategoryModal form').reset();
                loadCategories();
                await populateAllCategorySelects();
            } catch (error) {
                showToast('Fehler beim Hinzuf√ºgen der Kategorie', 'error');
                console.error(error);
            }
        }

        async function deleteCategory(id) {
            if (!confirm('M√∂chten Sie diese Kategorie wirklich l√∂schen?')) return;

            try {
                await deleteFromStore('categories', id);
                showToast('Kategorie gel√∂scht', 'success');
                loadCategories();
                await populateAllCategorySelects();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        async function populateAllCategorySelects() {
            const categories = await getAllFromStore('categories');
            
            // Alle Category-Selects finden und bef√ºllen
            const selects = [
                'transactionCategory',
                'recurringCategory',
                'budgetCategory',
                'filterCategory'
            ];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    const isFilter = selectId === 'filterCategory';
                    
                    select.innerHTML = isFilter ? '<option value="all">Alle Kategorien</option>' : '';
                    
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = `${cat.icon} ${cat.name}`;
                        select.appendChild(option);
                    });
                    
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        // ==================== ACCOUNTS MANAGEMENT ====================
        async function initializeAccounts() {
            const accounts = await getAllFromStore('accounts');
            if (accounts.length === 0) {
                for (const acc of DEFAULT_ACCOUNTS) {
                    await addToStore('accounts', acc);
                }
            }
        }

        async function loadAccounts() {
            const accounts = await getAllFromStore('accounts');
            const container = document.getElementById('accountsList');
            
            if (accounts.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Keine Konten vorhanden</p></div>';
                return;
            }

            container.innerHTML = accounts.map(acc => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-description">${acc.icon || 'üí≥'} ${acc.name}</div>
                        <div class="transaction-date">Saldo: ${formatCurrency(acc.balance || 0)}</div>
                    </div>
                    <div class="transaction-actions">
                        <button class="btn-icon" onclick="deleteAccount(${acc.id})" title="L√∂schen">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadAccountsModal() {
            const accounts = await getAllFromStore('accounts');
            const container = document.getElementById('accountsModalList');
            
            container.innerHTML = accounts.map(acc => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-description">${acc.icon || 'üí≥'} ${acc.name}</div>
                    </div>
                </div>
            `).join('');
        }

        async function addAccount(event) {
            event.preventDefault();

            const account = {
                name: document.getElementById('newAccountName').value,
                icon: document.getElementById('newAccountIcon').value || 'üí≥',
                balance: parseFloat(document.getElementById('newAccountBalance').value) || 0
            };

            try {
                await addToStore('accounts', account);
                showToast('Konto erfolgreich hinzugef√ºgt!', 'success');
                closeModal('addAccountModal');
                document.querySelector('#addAccountModal form').reset();
                loadAccounts();
                await populateAllAccountSelects();
                await loadAccountSelector();
            } catch (error) {
                showToast('Fehler beim Hinzuf√ºgen des Kontos', 'error');
                console.error(error);
            }
        }

        async function deleteAccount(id) {
            if (!confirm('M√∂chten Sie dieses Konto wirklich l√∂schen?')) return;

            try {
                await deleteFromStore('accounts', id);
                showToast('Konto gel√∂scht', 'success');
                loadAccounts();
                await populateAllAccountSelects();
                await loadAccountSelector();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        async function populateAllAccountSelects() {
            const accounts = await getAllFromStore('accounts');
            
            const selects = [
                'transactionAccount',
                'recurringAccount',
                'filterAccount'
            ];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    const isFilter = selectId === 'filterAccount';
                    
                    select.innerHTML = isFilter ? '<option value="all">Alle Konten</option>' : '<option value="">Kein Konto</option>';
                    
                    accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.name;
                        option.textContent = `${acc.icon || 'üí≥'} ${acc.name}`;
                        select.appendChild(option);
                    });
                    
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        async function loadAccountSelector() {
            const accounts = await getAllFromStore('accounts');
            const container = document.getElementById('accountSelector');
            
            let html = `<div class="account-chip ${selectedAccount === 'all' ? 'active' : ''}" onclick="selectAccount('all')">
                Alle Konten
            </div>`;
            
            accounts.forEach(acc => {
                html += `<div class="account-chip ${selectedAccount === acc.name ? 'active' : ''}" onclick="selectAccount('${acc.name}')">
                    ${acc.icon || 'üí≥'} ${acc.name}
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function selectAccount(accountName) {
            selectedAccount = accountName;
            loadAccountSelector();
            loadDashboard();
        }

        // ==================== TRANSACTIONS ====================
        async function addTransaction(event) {
            event.preventDefault();

            const tags = document.getElementById('transactionTags').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);

            const transaction = {
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                category: document.getElementById('transactionCategory').value,
                date: document.getElementById('transactionDate').value,
                description: document.getElementById('transactionDescription').value,
                account: document.getElementById('transactionAccount').value || '',
                note: document.getElementById('transactionNote').value || '',
                tags: tags,
                isRecurring: false,
                timestamp: new Date().getTime()
            };

            try {
                if (editingTransactionId) {
                    transaction.id = editingTransactionId;
                    await updateInStore('transactions', transaction);
                    showToast('Transaktion erfolgreich aktualisiert!', 'success');
                    editingTransactionId = null;
                    document.querySelector('#transactionForm button[type="submit"]').textContent = '‚ûï Transaktion hinzuf√ºgen';
                } else {
                    await addToStore('transactions', transaction);
                    showToast('Transaktion erfolgreich hinzugef√ºgt!', 'success');
                }
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionDate').valueAsDate = new Date();
                document.getElementById('transactionTagsPreview').innerHTML = '';
                loadDashboard();
                loadTransactions();
                loadBudgets();
                checkBudgetWarnings();
            } catch (error) {
                showToast('Fehler beim Speichern der Transaktion', 'error');
                console.error(error);
            }
        }

        async function editTransaction(id) {
            const transactions = await getAllFromStore('transactions');
            const transaction = transactions.find(t => t.id === id);
            
            if (!transaction) return;

            editingTransactionId = id;
            document.getElementById('transactionType').value = transaction.type;
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionCategory').value = transaction.category;
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionAccount').value = transaction.account || '';
            document.getElementById('transactionNote').value = transaction.note || '';
            document.getElementById('transactionTags').value = (transaction.tags || []).join(', ');
            
            document.querySelector('#transactionForm button[type="submit"]').textContent = 'üíæ Transaktion aktualisieren';
            
            switchSection('transactions');
            document.getElementById('transactionAmount').focus();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast('Transaktion wird bearbeitet', 'success');
        }

        async function deleteTransaction(id) {
            if (!confirm('M√∂chten Sie diese Transaktion wirklich l√∂schen?')) return;

            try {
                await deleteFromStore('transactions', id);
                showToast('Transaktion gel√∂scht', 'success');
                loadTransactions();
                loadDashboard();
                loadBudgets();
                checkBudgetWarnings();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        async function loadTransactions() {
            const transactions = await getAllFromStore('transactions');
            const container = document.getElementById('transactionsList');

            if (transactions.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>Noch keine Transaktionen vorhanden.</p></div>';
                return;
            }

            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = transactions.map(t => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <span class="transaction-category">${t.category}</span>
                        ${t.isRecurring ? '<span class="badge badge-recurring">üîÑ Auto</span>' : ''}
                        <div class="transaction-description">${t.description}</div>
                        ${t.note ? `<div style="color: var(--text-muted); font-size: 0.85rem;">üìù ${t.note}</div>` : ''}
                        ${t.account ? `<div style="color: var(--text-muted); font-size: 0.85rem;">Konto: ${t.account}</div>` : ''}
                        ${t.tags && t.tags.length > 0 ? `<div class="tags">${t.tags.map(tag => `<span class="badge badge-tag">#${tag}</span>`).join('')}</div>` : ''}
                        <div class="transaction-date">${formatDate(t.date)}</div>
                    </div>
                    <div class="transaction-amount ${t.type}">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                    </div>
                    <div class="transaction-actions">
                        ${!t.isRecurring ? `<button class="btn-icon" onclick="editTransaction(${t.id})" title="Bearbeiten">‚úèÔ∏è</button>` : ''}
                        <button class="btn-icon" onclick="deleteTransaction(${t.id})" title="L√∂schen">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function filterTransactions() {
            const typeFilter = document.getElementById('filterType').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            const periodFilter = document.getElementById('filterPeriod').value;
            const accountFilter = document.getElementById('filterAccount').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();

            let transactions = await getAllFromStore('transactions');
            const now = new Date();

            // Zeitraum-Filter
            if (periodFilter !== 'all') {
                transactions = transactions.filter(t => {
                    const d = new Date(t.date);
                    if (periodFilter === 'thisMonth') {
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    }
                    if (periodFilter === 'lastMonth') {
                        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        return d.getMonth() === lastMonth.getMonth() && d.getFullYear() === lastMonth.getFullYear();
                    }
                    if (periodFilter === 'thisYear') {
                        return d.getFullYear() === now.getFullYear();
                    }
                    if (periodFilter === 'last12') {
                        const twelveMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 11, 1);
                        return d >= twelveMonthsAgo && d <= now;
                    }
                    return true;
                });
            }

            // Typ-Filter
            if (typeFilter !== 'all') {
                transactions = transactions.filter(t => t.type === typeFilter);
            }

            // Kategorie-Filter
            if (categoryFilter !== 'all') {
                transactions = transactions.filter(t => t.category === categoryFilter);
            }

            // Account-Filter
            if (accountFilter !== 'all') {
                transactions = transactions.filter(t => t.account === accountFilter);
            }

            // Suche
            if (searchQuery) {
                transactions = transactions.filter(t => 
                    t.description.toLowerCase().includes(searchQuery) ||
                    t.category.toLowerCase().includes(searchQuery) ||
                    (t.account && t.account.toLowerCase().includes(searchQuery)) ||
                    (t.note && t.note.toLowerCase().includes(searchQuery)) ||
                    (t.tags && t.tags.some(tag => tag.toLowerCase().includes(searchQuery)))
                );
            }

            const container = document.getElementById('transactionsList');
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (transactions.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Keine Transaktionen gefunden.</p></div>';
                return;
            }

            container.innerHTML = transactions.map(t => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <span class="transaction-category">${t.category}</span>
                        ${t.isRecurring ? '<span class="badge badge-recurring">üîÑ Auto</span>' : ''}
                        <div class="transaction-description">${t.description}</div>
                        ${t.note ? `<div style="color: var(--text-muted); font-size: 0.85rem;">üìù ${t.note}</div>` : ''}
                        ${t.account ? `<div style="color: var(--text-muted); font-size: 0.85rem;">Konto: ${t.account}</div>` : ''}
                        ${t.tags && t.tags.length > 0 ? `<div class="tags">${t.tags.map(tag => `<span class="badge badge-tag">#${tag}</span>`).join('')}</div>` : ''}
                        <div class="transaction-date">${formatDate(t.date)}</div>
                    </div>
                    <div class="transaction-amount ${t.type}">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                    </div>
                    <div class="transaction-actions">
                        ${!t.isRecurring ? `<button class="btn-icon" onclick="editTransaction(${t.id})">‚úèÔ∏è</button>` : ''}
                        <button class="btn-icon" onclick="deleteTransaction(${t.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function resetFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterCategory').value = 'all';
            document.getElementById('filterPeriod').value = 'all';
            document.getElementById('filterAccount').value = 'all';
            document.getElementById('searchInput').value = '';
            loadTransactions();
        }

        function populateCategoryFilter() {
            getAllFromStore('categories').then(categories => {
                const filterCategory = document.getElementById('filterCategory');
                filterCategory.innerHTML = '<option value="all">Alle Kategorien</option>';
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = `${cat.icon} ${cat.name}`;
                    filterCategory.appendChild(option);
                });
            });
        }

        function populateAccountFilter() {
            getAllFromStore('accounts').then(accounts => {
                const filterAccount = document.getElementById('filterAccount');
                filterAccount.innerHTML = '<option value="all">Alle Konten</option>';
                
                accounts.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.name;
                    option.textContent = `${acc.icon || 'üí≥'} ${acc.name}`;
                    filterAccount.appendChild(option);
                });
            });
        }

        // ==================== TEMPLATES ====================
        async function saveAsTemplate() {
            const template = {
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                category: document.getElementById('transactionCategory').value,
                description: document.getElementById('transactionDescription').value,
                account: document.getElementById('transactionAccount').value || '',
                timestamp: new Date().getTime()
            };

            try {
                await addToStore('templates', template);
                showToast('Als Vorlage gespeichert!', 'success');
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
                console.error(error);
            }
        }

        async function loadTemplates() {
            const templates = await getAllFromStore('templates');
            const container = document.getElementById('templatesList');

            if (templates.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Keine Vorlagen vorhanden</p></div>';
                return;
            }

            container.innerHTML = templates.map(t => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <span class="transaction-category">${t.category}</span>
                        <div class="transaction-description">${t.description}</div>
                        ${t.account ? `<div style="color: var(--text-muted); font-size: 0.85rem;">Konto: ${t.account}</div>` : ''}
                    </div>
                    <div class="transaction-amount ${t.type}">
                        ${formatCurrency(t.amount)}
                    </div>
                    <div class="transaction-actions">
                        <button class="btn-icon" onclick="applyTemplate(${t.id})" title="Anwenden">‚úì</button>
                        <button class="btn-icon" onclick="deleteTemplate(${t.id})" title="L√∂schen">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function applyTemplate(id) {
            const templates = await getAllFromStore('templates');
            const template = templates.find(t => t.id === id);
            
            if (!template) return;

            document.getElementById('transactionType').value = template.type;
            document.getElementById('transactionAmount').value = template.amount;
            document.getElementById('transactionCategory').value = template.category;
            document.getElementById('transactionDescription').value = template.description;
            document.getElementById('transactionAccount').value = template.account || '';

            closeModal('templatesModal');
            showToast('Vorlage angewendet', 'success');
        }

        async function deleteTemplate(id) {
            if (!confirm('M√∂chten Sie diese Vorlage l√∂schen?')) return;

            try {
                await deleteFromStore('templates', id);
                showToast('Vorlage gel√∂scht', 'success');
                loadTemplates();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        // ==================== QUICK ADD ====================
        function showQuickAdd() {
            openModal('quickAddModal');
            document.getElementById('quickAmount').focus();
        }

        async function quickAddTransaction(event) {
            event.preventDefault();

            const type = event.submitter.value;
            const amount = parseFloat(document.getElementById('quickAmount').value);
            const description = document.getElementById('quickDescription').value;

            const transaction = {
                type: type,
                amount: amount,
                category: 'Sonstiges',
                date: dateToString(new Date()),
                description: description,
                account: '',
                note: '',
                tags: [],
                isRecurring: false,
                timestamp: new Date().getTime()
            };

            try {
                await addToStore('transactions', transaction);
                showToast('Transaktion schnell hinzugef√ºgt!', 'success');
                closeModal('quickAddModal');
                document.getElementById('quickAmount').value = '';
                document.getElementById('quickDescription').value = '';
                loadDashboard();
                loadBudgets();
                checkBudgetWarnings();
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
                console.error(error);
            }
        }
        // ==================== RECURRING TRANSACTIONS ====================
        function toggleRecurringEndOptions() {
            const endType = document.getElementById('recurringEndType').value;
            const endDateGroup = document.getElementById('recurringEndDateGroup');
            const endCountGroup = document.getElementById('recurringEndCountGroup');

            endDateGroup.style.display = endType === 'date' ? 'block' : 'none';
            endCountGroup.style.display = endType === 'count' ? 'block' : 'none';
        }

        async function addRecurring(event) {
            event.preventDefault();

            const endType = document.getElementById('recurringEndType').value;
            const recurring = {
                type: document.getElementById('recurringType').value,
                amount: parseFloat(document.getElementById('recurringAmount').value),
                category: document.getElementById('recurringCategory').value,
                description: document.getElementById('recurringDescription').value,
                account: document.getElementById('recurringAccount').value || '',
                frequency: document.getElementById('recurringInterval').value,
                startDate: document.getElementById('recurringStartDate').value,
                endType: endType,
                endDate: endType === 'date' ? document.getElementById('recurringEndDate').value : null,
                maxOccurrences: endType === 'count' ? parseInt(document.getElementById('recurringEndCount').value) : null,
                lastGeneratedDate: null,
                occurrenceCount: 0,
                active: true,
                timestamp: new Date().getTime()
            };

            try {
                if (editingRecurringId) {
                    recurring.id = editingRecurringId;
                    await updateInStore('recurring', recurring);
                    showToast('Dauerauftrag erfolgreich aktualisiert!', 'success');
                    editingRecurringId = null;
                    document.querySelector('#recurringForm button[type="submit"]').textContent = 'üîÑ Dauerauftrag erstellen';
                } else {
                    await addToStore('recurring', recurring);
                    showToast('Dauerauftrag erfolgreich erstellt!', 'success');
                }
                document.getElementById('recurringForm').reset();
                document.getElementById('recurringStartDate').valueAsDate = new Date();
                toggleRecurringEndOptions();
                loadRecurringTransactions();
            } catch (error) {
                showToast('Fehler beim Speichern des Dauerauftrags', 'error');
                console.error(error);
            }
        }

        async function editRecurring(id) {
            const recurring = await getAllFromStore('recurring');
            const item = recurring.find(r => r.id === id);
            
            if (!item) return;

            editingRecurringId = id;
            document.getElementById('recurringType').value = item.type;
            document.getElementById('recurringAmount').value = item.amount;
            document.getElementById('recurringCategory').value = item.category;
            document.getElementById('recurringDescription').value = item.description;
            document.getElementById('recurringAccount').value = item.account || '';
            document.getElementById('recurringInterval').value = item.frequency;
            document.getElementById('recurringStartDate').value = item.startDate;
            document.getElementById('recurringEndType').value = item.endType;
            
            if (item.endType === 'date') {
                document.getElementById('recurringEndDate').value = item.endDate;
            } else if (item.endType === 'count') {
                document.getElementById('recurringEndCount').value = item.maxOccurrences;
            }
            
            toggleRecurringEndOptions();
            
            document.querySelector('#recurringForm button[type="submit"]').textContent = 'üíæ Dauerauftrag aktualisieren';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast('Dauerauftrag wird bearbeitet', 'success');
        }

        async function deleteRecurring(id) {
            if (!confirm('M√∂chten Sie diesen Dauerauftrag wirklich l√∂schen?')) return;

            try {
                await deleteFromStore('recurring', id);
                showToast('Dauerauftrag gel√∂scht', 'success');
                loadRecurringTransactions();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        async function toggleRecurringStatus(id) {
            const recurring = await getAllFromStore('recurring');
            const item = recurring.find(r => r.id === id);
            
            if (!item) return;

            item.active = !item.active;
            
            try {
                await updateInStore('recurring', item);
                showToast(`Dauerauftrag ${item.active ? 'aktiviert' : 'pausiert'}`, 'success');
                loadRecurringTransactions();
            } catch (error) {
                showToast('Fehler beim √Ñndern des Status', 'error');
                console.error(error);
            }
        }

        async function loadRecurringTransactions() {
            const recurring = await getAllFromStore('recurring');
            const container = document.getElementById('recurringList');

            if (recurring.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîÑ</div><p>Noch keine Dauerauftr√§ge angelegt.</p></div>';
                return;
            }

            const frequencyLabels = {
                'daily': 'T√§glich',
                'weekly': 'W√∂chentlich',
                'biweekly': 'Zweiw√∂chentlich',
                'monthly': 'Monatlich',
                'quarterly': 'Quartalsweise',
                'yearly': 'J√§hrlich'
            };

            container.innerHTML = recurring.map(r => {
                let endInfo = 'Kein Ende';
                if (r.endType === 'date') {
                    endInfo = `Bis ${formatDate(r.endDate)}`;
                } else if (r.endType === 'count') {
                    endInfo = `${r.occurrenceCount}/${r.maxOccurrences} ausgef√ºhrt`;
                }

                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <span class="transaction-category">${r.category}</span>
                            <span class="badge ${r.active ? 'badge-active' : 'badge-paused'}">
                                ${r.active ? '‚úì Aktiv' : '‚è∏ Pausiert'}
                            </span>
                            <div class="transaction-description">${r.description}</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem;">
                                ${frequencyLabels[r.frequency]} ‚Ä¢ Start: ${formatDate(r.startDate)} ‚Ä¢ ${endInfo}
                                ${r.account ? ` ‚Ä¢ Konto: ${r.account}` : ''}
                            </div>
                            ${r.lastGeneratedDate ? `<div style="color: var(--text-muted); font-size: 0.85rem;">Zuletzt generiert: ${formatDate(r.lastGeneratedDate)}</div>` : ''}
                        </div>
                        <div class="transaction-amount ${r.type}">
                            ${r.type === 'income' ? '+' : '-'}${formatCurrency(r.amount)}
                        </div>
                        <div class="transaction-actions">
                            <button class="btn-icon" onclick="generateRecurringInstances(${r.id})" title="Jetzt generieren">‚ö°</button>
                            <button class="btn-icon" onclick="toggleRecurringStatus(${r.id})" title="${r.active ? 'Pausieren' : 'Aktivieren'}">
                                ${r.active ? '‚è∏' : '‚ñ∂'}
                            </button>
                            <button class="btn-icon" onclick="editRecurring(${r.id})" title="Bearbeiten">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="deleteRecurring(${r.id})" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Preview vor Generierung (verhindert Duplikate)
        async function previewRecurringGeneration() {
            const recurring = await getAllFromStore('recurring');
            const activeRecurring = recurring.filter(r => r.active);

            if (activeRecurring.length === 0) {
                showToast('Keine aktiven Dauerauftr√§ge vorhanden', 'error');
                return;
            }

            const transactions = await getAllFromStore('transactions');
            const preview = [];

            for (const item of activeRecurring) {
                const instances = await calculateRecurringInstances(item);
                
                // Pr√ºfe auf Duplikate
                for (const inst of instances) {
                    const isDuplicate = transactions.some(t => 
                        t.isRecurring && 
                        t.recurringId === item.id && 
                        t.date === inst.date
                    );
                    
                    if (!isDuplicate) {
                        preview.push({
                            recurring: item,
                            instance: inst
                        });
                    }
                }
            }

            if (preview.length === 0) {
                showToast('Keine neuen Transaktionen f√§llig', 'info');
                return;
            }

            // Zeige Preview Modal
            const container = document.getElementById('recurringPreviewList');
            container.innerHTML = `
                <div class="alert alert-info">
                    <strong>${preview.length}</strong> neue Transaktionen werden erstellt:
                </div>
                ${preview.map(p => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <span class="transaction-category">${p.recurring.category}</span>
                            <div class="transaction-description">${p.recurring.description}</div>
                            <div class="transaction-date">${formatDate(p.instance.date)}</div>
                        </div>
                        <div class="transaction-amount ${p.recurring.type}">
                            ${p.recurring.type === 'income' ? '+' : '-'}${formatCurrency(p.recurring.amount)}
                        </div>
                    </div>
                `).join('')}
            `;

            // Speichere Preview tempor√§r
            window.recurringPreviewData = preview;

            openModal('recurringPreviewModal');
        }

        async function confirmRecurringGeneration() {
            const preview = window.recurringPreviewData;
            if (!preview) return;

            let count = 0;

            for (const p of preview) {
                const transaction = {
                    type: p.recurring.type,
                    amount: p.recurring.amount,
                    category: p.recurring.category,
                    date: p.instance.date,
                    description: p.recurring.description,
                    account: p.recurring.account,
                    note: '',
                    tags: [],
                    isRecurring: true,
                    recurringId: p.recurring.id,
                    timestamp: new Date().getTime()
                };

                await addToStore('transactions', transaction);
                count++;

                // Update recurring
                p.recurring.occurrenceCount++;
                p.recurring.lastGeneratedDate = p.instance.date;
                await updateInStore('recurring', p.recurring);
            }

            closeModal('recurringPreviewModal');
            showToast(`${count} Transaktion(en) erstellt`, 'success');
            loadTransactions();
            loadDashboard();
            loadRecurringTransactions();
            checkBudgetWarnings();
        }

        async function generateRecurringInstances(recurringId) {
            const recurring = await getAllFromStore('recurring');
            const item = recurring.find(r => r.id === recurringId);
            
            if (!item || !item.active) {
                showToast('Dauerauftrag ist nicht aktiv', 'error');
                return;
            }

            const transactions = await getAllFromStore('transactions');
            const instances = await calculateRecurringInstances(item);
            let count = 0;

            for (const inst of instances) {
                // Pr√ºfe auf Duplikat
                const isDuplicate = transactions.some(t => 
                    t.isRecurring && 
                    t.recurringId === item.id && 
                    t.date === inst.date
                );

                if (!isDuplicate) {
                    const transaction = {
                        type: item.type,
                        amount: item.amount,
                        category: item.category,
                        date: inst.date,
                        description: item.description,
                        account: item.account,
                        note: '',
                        tags: [],
                        isRecurring: true,
                        recurringId: item.id,
                        timestamp: new Date().getTime()
                    };

                    await addToStore('transactions', transaction);
                    count++;
                }
            }

            if (count > 0) {
                item.occurrenceCount += count;
                item.lastGeneratedDate = dateToString(new Date());
                await updateInStore('recurring', item);
                
                showToast(`${count} Transaktion(en) erstellt`, 'success');
                loadTransactions();
                loadDashboard();
                loadRecurringTransactions();
                checkBudgetWarnings();
            } else {
                showToast('Keine neuen Transaktionen f√§llig', 'info');
            }
        }

        async function calculateRecurringInstances(recurring) {
            const now = new Date();
            const startDate = new Date(recurring.startDate);
            const lastGenerated = recurring.lastGeneratedDate ? new Date(recurring.lastGeneratedDate) : null;
            
            let currentDate = lastGenerated ? addDaysToDateHelper(lastGenerated, recurring.frequency) : new Date(startDate);
            
            const instances = [];
            const maxIterations = 1000;
            let iterations = 0;

            while (currentDate <= now && iterations < maxIterations) {
                iterations++;

                // Pr√ºfe End-Bedingungen
                if (recurring.endType === 'date' && recurring.endDate) {
                    if (currentDate > new Date(recurring.endDate)) break;
                }
                
                if (recurring.endType === 'count' && recurring.maxOccurrences) {
                    if (recurring.occurrenceCount >= recurring.maxOccurrences) break;
                }

                instances.push({ date: dateToString(currentDate) });
                
                // N√§chstes Datum berechnen
                currentDate = addDaysToDateHelper(currentDate, recurring.frequency);
            }

            return instances;
        }

        function addDaysToDateHelper(date, frequency) {
            switch(frequency) {
                case 'daily':
                    return addDays(date, 1);
                case 'weekly':
                    return addWeeks(date, 1);
                case 'biweekly':
                    return addWeeks(date, 2);
                case 'monthly':
                    return addMonths(date, 1);
                case 'quarterly':
                    return addMonths(date, 3);
                case 'yearly':
                    return addYears(date, 1);
                default:
                    return addDays(date, 1);
            }
        }

        // ==================== BUDGETS ====================
        async function addBudget(event) {
            event.preventDefault();

            const budget = {
                category: document.getElementById('budgetCategory').value,
                limit: parseFloat(document.getElementById('budgetLimit').value),
                notifications: document.getElementById('budgetNotifications').checked
            };

            try {
                await addToStore('budgets', budget);
                showToast('Budget erfolgreich erstellt!', 'success');
                document.getElementById('budgetForm').reset();
                loadBudgets();
                checkBudgetWarnings();
            } catch (error) {
                if (error.name === 'ConstraintError') {
                    showToast('Budget f√ºr diese Kategorie existiert bereits', 'error');
                } else {
                    showToast('Fehler beim Erstellen des Budgets', 'error');
                }
                console.error(error);
            }
        }

        async function loadBudgets() {
            const budgets = await getAllFromStore('budgets');
            const transactions = await getAllFromStore('transactions');
            const container = document.getElementById('budgetsList');

            if (budgets.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéØ</div><p>Noch keine Budgets definiert.</p></div>';
                return;
            }

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const categorySpending = {};
            transactions
                .filter(t => {
                    const tDate = new Date(t.date);
                    return t.type === 'expense' && 
                           tDate.getMonth() === currentMonth && 
                           tDate.getFullYear() === currentYear;
                })
                .forEach(t => {
                    categorySpending[t.category] = (categorySpending[t.category] || 0) + t.amount;
                });

            container.innerHTML = budgets.map(b => {
                const spent = categorySpending[b.category] || 0;
                const percentage = Math.min((spent / b.limit) * 100, 100);
                const remaining = b.limit - spent;
                
                let progressClass = 'low';
                if (percentage >= 100) progressClass = 'high';
                else if (percentage >= 80) progressClass = 'medium';

                return `
                    <div class="budget-item">
                        <div class="budget-header">
                            <span class="budget-name">${b.category} ${b.notifications ? 'üîî' : ''}</span>
                            <span class="budget-stats">${formatCurrency(spent)} / ${formatCurrency(b.limit)}</span>
                        </div>
                        <div class="budget-progress-bar">
                            <div class="budget-progress-fill ${progressClass}" style="width: ${percentage}%">
                                ${percentage.toFixed(0)}%
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                            ${remaining >= 0 ? `Noch ${formatCurrency(remaining)} verf√ºgbar` : `${formatCurrency(Math.abs(remaining))} √ºber Budget`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function checkBudgetWarnings() {
            const budgets = await getAllFromStore('budgets');
            const transactions = await getAllFromStore('transactions');
            const container = document.getElementById('budgetWarnings');

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const categorySpending = {};
            transactions
                .filter(t => {
                    const tDate = new Date(t.date);
                    return t.type === 'expense' && 
                           tDate.getMonth() === currentMonth && 
                           tDate.getFullYear() === currentYear;
                })
                .forEach(t => {
                    categorySpending[t.category] = (categorySpending[t.category] || 0) + t.amount;
                });

            const warnings = [];

            budgets.forEach(b => {
                if (!b.notifications) return;

                const spent = categorySpending[b.category] || 0;
                const percentage = (spent / b.limit) * 100;

                if (percentage >= 100) {
                    warnings.push({ category: b.category, percentage, type: 'danger' });
                } else if (percentage >= 90) {
                    warnings.push({ category: b.category, percentage, type: 'warning' });
                } else if (percentage >= 80) {
                    warnings.push({ category: b.category, percentage, type: 'warning' });
                }
            });

            if (warnings.length > 0) {
                container.innerHTML = warnings.map(w => `
                    <div class="alert alert-${w.type}">
                        <strong>‚ö†Ô∏è Budget-Warnung:</strong> ${w.category} ist zu ${w.percentage.toFixed(0)}% ausgesch√∂pft!
                    </div>
                `).join('');
            } else {
                container.innerHTML = '';
            }
        }

        // ==================== GOALS (SPARZIELE) ====================
        async function addGoal(event) {
            event.preventDefault();

            const goal = {
                name: document.getElementById('goalName').value,
                target: parseFloat(document.getElementById('goalTarget').value),
                current: parseFloat(document.getElementById('goalCurrent').value),
                deadline: document.getElementById('goalDeadline').value || null,
                note: document.getElementById('goalNote').value || '',
                timestamp: new Date().getTime()
            };

            try {
                if (editingGoalId) {
                    goal.id = editingGoalId;
                    await updateInStore('goals', goal);
                    showToast('Sparziel aktualisiert!', 'success');
                    editingGoalId = null;
                } else {
                    await addToStore('goals', goal);
                    showToast('Sparziel erstellt!', 'success');
                }
                document.getElementById('goalForm').reset();
                loadGoals();
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
                console.error(error);
            }
        }

        async function loadGoals() {
            const goals = await getAllFromStore('goals');
            const container = document.getElementById('goalsList');

            if (goals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéñÔ∏è</div><p>Noch keine Sparziele definiert.</p></div>';
                return;
            }

            container.innerHTML = goals.map(g => {
                const percentage = Math.min((g.current / g.target) * 100, 100);
                const remaining = g.target - g.current;
                
                let timeInfo = '';
                if (g.deadline) {
                    const daysLeft = Math.ceil((new Date(g.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                    timeInfo = daysLeft > 0 ? `${daysLeft} Tage verbleibend` : 'Abgelaufen';
                }

                return `
                    <div class="goal-item">
                        <div class="goal-header">
                            <div class="goal-title">${g.name}</div>
                            <div class="goal-amount">${formatCurrency(g.current)} / ${formatCurrency(g.target)}</div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-fill" style="width: ${percentage}%">
                                ${percentage.toFixed(0)}%
                            </div>
                        </div>
                        <div class="goal-meta">
                            <span>Noch ${formatCurrency(remaining)} ben√∂tigt</span>
                            <span>${timeInfo}</span>
                        </div>
                        ${g.note ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.5rem;">${g.note}</div>` : ''}
                        <div class="flex gap-1 mt-1">
                            <button class="btn btn-sm btn-success" onclick="updateGoalProgress(${g.id})">üí∞ Fortschritt aktualisieren</button>
                            <button class="btn btn-sm btn-secondary" onclick="editGoal(${g.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteGoal(${g.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateGoalProgress(id) {
            const goals = await getAllFromStore('goals');
            const goal = goals.find(g => g.id === id);
            
            if (!goal) return;

            const newAmount = prompt(`Neuer Betrag f√ºr "${goal.name}" (aktuell: ${formatCurrency(goal.current)}):`, goal.current);
            
            if (newAmount !== null) {
                goal.current = parseFloat(newAmount);
                
                try {
                    await updateInStore('goals', goal);
                    showToast('Fortschritt aktualisiert!', 'success');
                    loadGoals();
                } catch (error) {
                    showToast('Fehler beim Aktualisieren', 'error');
                    console.error(error);
                }
            }
        }

        async function editGoal(id) {
            const goals = await getAllFromStore('goals');
            const goal = goals.find(g => g.id === id);
            
            if (!goal) return;

            editingGoalId = id;
            document.getElementById('goalName').value = goal.name;
            document.getElementById('goalTarget').value = goal.target;
            document.getElementById('goalCurrent').value = goal.current;
            document.getElementById('goalDeadline').value = goal.deadline || '';
            document.getElementById('goalNote').value = goal.note || '';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast('Sparziel wird bearbeitet', 'success');
        }

        async function deleteGoal(id) {
            if (!confirm('M√∂chten Sie dieses Sparziel l√∂schen?')) return;

            try {
                await deleteFromStore('goals', id);
                showToast('Sparziel gel√∂scht', 'success');
                loadGoals();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        // ==================== SUBSCRIPTIONS (ABOS) ====================
        async function addSubscription(event) {
            event.preventDefault();

            const subscription = {
                name: document.getElementById('subscriptionName').value,
                cost: parseFloat(document.getElementById('subscriptionCost').value),
                category: document.getElementById('subscriptionCategory').value,
                renewal: document.getElementById('subscriptionRenewal').value,
                nextDate: document.getElementById('subscriptionNextDate').value,
                cancellation: parseInt(document.getElementById('subscriptionCancellation').value),
                reminder: document.getElementById('subscriptionReminder').checked,
                timestamp: new Date().getTime()
            };

            try {
                if (editingSubscriptionId) {
                    subscription.id = editingSubscriptionId;
                    await updateInStore('subscriptions', subscription);
                    showToast('Abo aktualisiert!', 'success');
                    editingSubscriptionId = null;
                } else {
                    await addToStore('subscriptions', subscription);
                    showToast('Abo hinzugef√ºgt!', 'success');
                }
                document.getElementById('subscriptionForm').reset();
                loadSubscriptions();
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
                console.error(error);
            }
        }

        async function loadSubscriptions() {
            const subscriptions = await getAllFromStore('subscriptions');
            const container = document.getElementById('subscriptionsList');

            if (subscriptions.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÜ</div><p>Noch keine Abos erfasst.</p></div>';
                document.getElementById('subscriptionTotal').textContent = '0,00 ‚Ç¨/Monat';
                return;
            }

            // Gesamtkosten berechnen
            const totalMonthlyCost = subscriptions.reduce((sum, s) => {
                let monthlyCost = s.cost;
                if (s.renewal === 'quarterly') monthlyCost = s.cost / 3;
                if (s.renewal === 'yearly') monthlyCost = s.cost / 12;
                return sum + monthlyCost;
            }, 0);

            document.getElementById('subscriptionTotal').textContent = formatCurrency(totalMonthlyCost) + '/Monat';

            const now = new Date();

            container.innerHTML = subscriptions.map(s => {
                const nextDate = new Date(s.nextDate);
                const daysUntilRenewal = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));
                const cancelBy = new Date(nextDate);
                cancelBy.setDate(cancelBy.getDate() - s.cancellation);
                const daysUntilCancel = Math.ceil((cancelBy - now) / (1000 * 60 * 60 * 24));

                let warning = '';
                if (daysUntilCancel <= 7 && daysUntilCancel > 0) {
                    warning = `<div class="subscription-warning">‚ö†Ô∏è K√ºndigungsfrist endet in ${daysUntilCancel} Tagen!</div>`;
                }

                const renewalLabels = {
                    'monthly': 'Monatlich',
                    'quarterly': 'Quartalsweise',
                    'yearly': 'J√§hrlich'
                };

                return `
                    <div class="subscription-item">
                        <div class="subscription-info">
                            <div class="subscription-name">${s.name} ${s.reminder ? 'üîî' : ''}</div>
                            <div class="subscription-meta">
                                ${s.category} ‚Ä¢ ${renewalLabels[s.renewal]} ‚Ä¢ N√§chste Abrechnung: ${formatDate(s.nextDate)}
                                ${daysUntilRenewal > 0 ? `(in ${daysUntilRenewal} Tagen)` : '(heute!)'}
                            </div>
                            ${warning}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-danger);">
                                ${formatCurrency(s.cost)}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                ${renewalLabels[s.renewal]}
                            </div>
                        </div>
                        <div class="transaction-actions">
                            <button class="btn-icon" onclick="editSubscription(${s.id})" title="Bearbeiten">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="deleteSubscription(${s.id})" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function editSubscription(id) {
            const subscriptions = await getAllFromStore('subscriptions');
            const sub = subscriptions.find(s => s.id === id);
            
            if (!sub) return;

            editingSubscriptionId = id;
            document.getElementById('subscriptionName').value = sub.name;
            document.getElementById('subscriptionCost').value = sub.cost;
            document.getElementById('subscriptionCategory').value = sub.category;
            document.getElementById('subscriptionRenewal').value = sub.renewal;
            document.getElementById('subscriptionNextDate').value = sub.nextDate;
            document.getElementById('subscriptionCancellation').value = sub.cancellation;
            document.getElementById('subscriptionReminder').checked = sub.reminder;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast('Abo wird bearbeitet', 'success');
        }

        async function deleteSubscription(id) {
            if (!confirm('M√∂chten Sie dieses Abo l√∂schen?')) return;

            try {
                await deleteFromStore('subscriptions', id);
                showToast('Abo gel√∂scht', 'success');
                loadSubscriptions();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        // ==================== DASHBOARD ====================
        async function loadDashboard() {
            let transactions = await getAllFromStore('transactions');
            const immobilienTransactions = await getAllFromStore('immobilienTransactions');
            
            // Filter nach Konto wenn ausgew√§hlt
            if (selectedAccount !== 'all') {
                transactions = transactions.filter(t => t.account === selectedAccount);
            }

            // Kombiniere normale und Immobilien-Transaktionen f√ºr Gesamtbilanz
            const allTransactions = [...transactions, ...immobilienTransactions];

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Berechne Gesamtsaldo
            let totalBalance = 0;
            allTransactions.forEach(t => {
                totalBalance += t.type === 'income' ? t.amount : -t.amount;
            });

            // Berechne Monatswerte
            const monthTransactions = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            const monthIncome = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const monthExpense = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const savingsRate = monthIncome > 0 ? ((monthIncome - monthExpense) / monthIncome * 100) : 0;

            document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
            document.getElementById('monthIncome').textContent = formatCurrency(monthIncome);
            document.getElementById('monthExpense').textContent = formatCurrency(monthExpense);
            document.getElementById('monthSavingsRate').textContent = savingsRate.toFixed(1) + '%';
            document.getElementById('balanceAccount').textContent = selectedAccount === 'all' ? 'Alle Konten' : selectedAccount;

            // F√§rbe Sparquote
            const savingsRateEl = document.getElementById('monthSavingsRate');
            if (savingsRate > 30) {
                savingsRateEl.classList.add('positive');
                savingsRateEl.classList.remove('negative', 'neutral');
            } else if (savingsRate > 10) {
                savingsRateEl.classList.add('neutral');
                savingsRateEl.classList.remove('positive', 'negative');
            } else {
                savingsRateEl.classList.add('negative');
                savingsRateEl.classList.remove('positive', 'neutral');
            }

            // Lade Charts
            loadBalanceHistoryChart();
            loadCategoryChart();
            loadTrendChart();

            // Lade letzte Transaktionen
            loadRecentTransactions();

            // Lade n√§chste f√§llige Transaktionen
            loadUpcomingTransactions();

            // Budget-Warnungen pr√ºfen
            checkBudgetWarnings();
        }

        async function loadBalanceHistoryChart() {
            const transactions = await getAllFromStore('transactions');
            const immobilienTransactions = await getAllFromStore('immobilienTransactions');
            const allTransactions = [...transactions, ...immobilienTransactions].sort((a, b) => new Date(a.date) - new Date(b.date));

            const balanceHistory = [];
            let runningBalance = 0;

            // Startpunkt
            if (allTransactions.length > 0) {
                const firstDate = new Date(allTransactions[0].date);
                balanceHistory.push({ date: dateToString(firstDate), balance: 0 });
            }

            allTransactions.forEach(t => {
                runningBalance += t.type === 'income' ? t.amount : -t.amount;
                balanceHistory.push({ date: t.date, balance: runningBalance });
            });

            const ctx = document.getElementById('balanceHistoryChart');
            if (!ctx) return;

            if (balanceHistoryChart) balanceHistoryChart.destroy();

            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#f1f5f9' : '#0f172a';
            const gridColor = isDark ? '#475569' : '#cbd5e1';

            balanceHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: balanceHistory.map(b => formatDate(b.date)),
                    datasets: [{
                        label: 'Kontostand',
                        data: balanceHistory.map(b => b.balance),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: textColor,
                                callback: (value) => formatCurrency(value)
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor, maxRotation: 45, minRotation: 45 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function loadCategoryChart() {
            const period = document.getElementById('categoryChartPeriod')?.value || 'thisMonth';
            let transactions = await getAllFromStore('transactions');

            const now = new Date();
            transactions = transactions.filter(t => {
                const d = new Date(t.date);
                if (period === 'thisMonth') {
                    return t.type === 'expense' && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                } else if (period === 'lastMonth') {
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    return t.type === 'expense' && d.getMonth() === lastMonth.getMonth() && d.getFullYear() === lastMonth.getFullYear();
                } else if (period === 'thisYear') {
                    return t.type === 'expense' && d.getFullYear() === now.getFullYear();
                }
                return t.type === 'expense';
            });

            const categoryTotals = {};
            transactions.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });

            const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);

            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;

            if (categoryChart) categoryChart.destroy();

            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#f1f5f9' : '#0f172a';

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCategories.map(c => c[0]),
                    datasets: [{
                        data: sortedCategories.map(c => c[1]),
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                            '#06b6d4', '#ec4899', '#14b8a6', '#f97316', '#6366f1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${formatCurrency(context.parsed)}`
                            }
                        }
                    }
                }
            });
        }

        async function loadTrendChart() {
            const transactions = await getAllFromStore('transactions');
            
            const monthlyData = {};
            transactions.forEach(t => {
                const d = new Date(t.date);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[key]) {
                    monthlyData[key] = { income: 0, expense: 0 };
                }
                
                if (t.type === 'income') {
                    monthlyData[key].income += t.amount;
                } else {
                    monthlyData[key].expense += t.amount;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort().slice(-6);

            const ctx = document.getElementById('trendChart');
            if (!ctx) return;

            if (trendChart) trendChart.destroy();

            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#f1f5f9' : '#0f172a';
            const gridColor = isDark ? '#475569' : '#cbd5e1';

            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, parseInt(month) - 1).toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [
                        {
                            label: 'Einnahmen',
                            data: sortedMonths.map(m => monthlyData[m].income),
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Ausgaben',
                            data: sortedMonths.map(m => monthlyData[m].expense),
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: textColor,
                                callback: (value) => formatCurrency(value)
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function loadRecentTransactions() {
            const transactions = await getAllFromStore('transactions');
            const container = document.getElementById('recentTransactions');

            const recent = transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Noch keine Transaktionen vorhanden.</p></div>';
                return;
            }

            container.innerHTML = recent.map(t => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <span class="transaction-category">${t.category}</span>
                        <div class="transaction-description">${t.description}</div>
                        <div class="transaction-date">${formatDate(t.date)}</div>
                    </div>
                    <div class="transaction-amount ${t.type}">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                    </div>
                </div>
            `).join('');
        }

        async function loadUpcomingTransactions() {
            const recurring = await getAllFromStore('recurring');
            const container = document.getElementById('upcomingTransactions');

            const upcoming = [];
            const now = new Date();

            for (const r of recurring) {
                if (!r.active) continue;

                const lastGenerated = r.lastGeneratedDate ? new Date(r.lastGeneratedDate) : new Date(r.startDate);
                let nextDate = addDaysToDateHelper(lastGenerated, r.frequency);

                if (nextDate <= now) {
                    nextDate = addDaysToDateHelper(now, r.frequency);
                }

                const daysUntil = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));

                if (daysUntil <= 7) {
                    upcoming.push({
                        description: r.description,
                        category: r.category,
                        amount: r.amount,
                        type: r.type,
                        date: nextDate,
                        daysUntil: daysUntil
                    });
                }
            }

            upcoming.sort((a, b) => a.date - b.date);

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Keine f√§lligen Transaktionen in den n√§chsten 7 Tagen.</p></div>';
                return;
            }

            container.innerHTML = upcoming.map(u => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <span class="transaction-category">${u.category}</span>
                        <span class="badge badge-recurring">üîÑ F√§llig in ${u.daysUntil} Tag(en)</span>
                        <div class="transaction-description">${u.description}</div>
                        <div class="transaction-date">${formatDate(dateToString(u.date))}</div>
                    </div>
                    <div class="transaction-amount ${u.type}">
                        ${u.type === 'income' ? '+' : '-'}${formatCurrency(u.amount)}
                    </div>
                </div>
            `).join('');
        }

        // ==================== ANALYTICS ====================
        async function loadAnalytics() {
            loadYearlyChart();
            loadTopCategories();
            loadSavingsChart();
            loadWeekdayChart();
            loadYearComparisonChart();
        }

        async function loadYearlyChart() {
            const transactions = await getAllFromStore('transactions');
            const currentYear = new Date().getFullYear();

            const monthlyData = {};
            for (let i = 0; i < 12; i++) {
                monthlyData[i] = { income: 0, expense: 0 };
            }

            transactions.filter(t => new Date(t.date).getFullYear() === currentYear).forEach(t => {
                const month = new Date(t.date).getMonth();
                if (t.type === 'income') {
                    monthlyData[month].income += t.amount;
                } else {
                    monthlyData[month].expense += t.amount;
                }
            });

            const ctx = document.getElementById('yearlyChart');
            if (!ctx) return;

            if (yearlyChart) yearlyChart.destroy();

            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#f1f5f9' : '#0f172a';
            const gridColor = isDark ? '#475569' : '#cbd5e1';

            yearlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
                    datasets: [
                        {
                            label: 'Einnahmen',
                            data: Object.values(monthlyData).map(d => d.income),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Ausgaben',
                            data: Object.values(monthlyData).map(d => d.expense),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: textColor,
                                callback: (value) => formatCurrency(value)
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function loadTopCategories() {
            const transactions = await getAllFromStore('transactions');
            const currentYear = new Date().getFullYear();

            const categoryTotals = {};
            transactions
                .filter(t => t.type === 'expense' && new Date(t.date).getFullYear() === currentYear)
                .forEach(t => {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                });

            const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).slice(0, 5);

            const container = document.getElementById('topCategories');
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Noch keine Ausgaben vorhanden.</p></div>';
                return;
            }

            container.innerHTML = sorted.map((c, index) => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-description">${index + 1}. ${c[0]}</div>
                    </div>
                    <div class="transaction-amount expense">
                        ${formatCurrency(c[1])}
                    </div>
                </div>
            `).join('');
        }

        async function loadSavingsChart() {
            const transactions = await getAllFromStore('transactions');
            
            const monthlyData = {};
            transactions.forEach(t => {
                const d = new Date(t.date);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[key]) {
                    monthlyData[key] = { income: 0, expense: 0 };
                }
                
                if (t.type === 'income') {
                    monthlyData[key].income += t.amount;
                } else {
                    monthlyData[key].expense += t.amount;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort().slice(-12);
            const savingsRates = sortedMonths.map(m => {
                const data = monthlyData[m];
                return data.income > 0 ? ((data.income - data.expense) / data.income * 100) : 0;
            });

            const ctx = document.getElementById('savingsChart');
            if (!ctx) return;

            if (savingsChart) savingsChart.destroy();

            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#f1f5f9' : '#0f172a';
            const gridColor = isDark ? '#475569' : '#cbd5e1';

            savingsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, parseInt(month) - 1).toLocaleDateString('de-DE', { month: 'short' });
                    }),
                    datasets: [{
                        label: 'Sparquote (%)',
                        data: savingsRates,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.parsed.y.toFixed(1)}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: textColor,
                                callback: (value) => value + '%'
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function loadWeekdayChart() {
            const transactions = await getAllFromStore('transactions');
            
            const weekdayTotals = [0, 0, 0, 0, 0, 0, 0]; // So-Sa
            transactions.filter(t => t.type === 'expense').forEach(t => {
                const day = new Date(t.date).getDay();
                weekdayTotals[day] += t.amount;
            });

            const ctx = document.getElementById('weekdayChart');
            if (!ctx) return;

            if (weekdayChart) weekdayChart.destroy();

            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#f1f5f9' : '#0f172a';
            const gridColor = isDark ? '#475569' : '#cbd5e1';

            weekdayChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'],
                    datasets: [{
                        label: 'Ausgaben',
                        data: weekdayTotals,
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: textColor,
                                callback: (value) => formatCurrency(value)
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function loadYearComparisonChart() {
            const transactions = await getAllFromStore('transactions');
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;

            const currentYearData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            const lastYearData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            transactions.filter(t => t.type === 'expense').forEach(t => {
                const d = new Date(t.date);
                const month = d.getMonth();
                const year = d.getFullYear();

                if (year === currentYear) {
                    currentYearData[month] += t.amount;
                } else if (year === lastYear) {
                    lastYearData[month] += t.amount;
                }
            });

            const ctx = document.getElementById('yearComparisonChart');
            if (!ctx) return;

            if (yearComparisonChart) yearComparisonChart.destroy();

            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#f1f5f9' : '#0f172a';
            const gridColor = isDark ? '#475569' : '#cbd5e1';

            yearComparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
                    datasets: [
                        {
                            label: currentYear,
                            data: currentYearData,
                            borderColor: '#3b82f6',
                            tension: 0.4
                        },
                        {
                            label: lastYear,
                            data: lastYearData,
                            borderColor: '#94a3b8',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: textColor,
                                callback: (value) => formatCurrency(value)
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ==================== IMMOBILIEN ====================
        async function addImmobilie(event) {
            event.preventDefault();

            const immobilie = {
                name: document.getElementById('immobilienName').value,
                adresse: document.getElementById('immobilienAdresse').value,
                kaufpreis: parseFloat(document.getElementById('immobilienKaufpreis').value),
                miete: parseFloat(document.getElementById('immobilienMiete').value),
                wohneinheiten: parseInt(document.getElementById('immobilienWohneinheiten').value),
                kaufdatum: document.getElementById('immobilienKaufdatum').value,
                timestamp: new Date().getTime()
            };

            try {
                if (editingImmobilieId) {
                    immobilie.id = editingImmobilieId;
                    await updateInStore('immobilien', immobilie);
                    showToast('Immobilie aktualisiert!', 'success');
                    editingImmobilieId = null;
                } else {
                    await addToStore('immobilien', immobilie);
                    showToast('Immobilie hinzugef√ºgt!', 'success');
                }
                document.getElementById('immobilienForm').reset();
                document.getElementById('immobilienKaufdatum').valueAsDate = new Date();
                loadImmobilien();
                updateImmobilienSelects();
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
                console.error(error);
            }
        }

        async function loadImmobilien() {
            const immobilien = await getAllFromStore('immobilien');
            const immobilienTransactions = await getAllFromStore('immobilienTransactions');
            const listContainer = document.getElementById('immobilienListe');

            if (immobilien.length === 0) {
                listContainer.innerHTML = '<div class="empty-state"><p>Noch keine Immobilien erfasst.</p></div>';
                document.getElementById('portfolioWert').textContent = '0,00 ‚Ç¨';
                document.getElementById('portfolioMieten').textContent = '0,00 ‚Ç¨';
                document.getElementById('portfolioRendite').textContent = '0,0%';
                document.getElementById('portfolioCashflow').textContent = '0,00 ‚Ç¨';
                return;
            }

            // Portfolio-Statistiken
            const totalValue = immobilien.reduce((sum, i) => sum + i.kaufpreis, 0);
            const totalRent = immobilien.reduce((sum, i) => sum + i.miete, 0);
            const avgYield = totalValue > 0 ? ((totalRent * 12) / totalValue) * 100 : 0;

            // Berechne tats√§chlichen Cashflow
            const currentYear = new Date().getFullYear();
            const yearlyIncome = immobilienTransactions.filter(t => 
                t.type === 'income' && new Date(t.date).getFullYear() === currentYear
            ).reduce((sum, t) => sum + t.amount, 0);
            const yearlyExpenses = immobilienTransactions.filter(t => 
                t.type === 'expense' && new Date(t.date).getFullYear() === currentYear
            ).reduce((sum, t) => sum + t.amount, 0);
            const monthlyCashflow = (yearlyIncome - yearlyExpenses) / 12;

            document.getElementById('portfolioWert').textContent = formatCurrency(totalValue);
            document.getElementById('portfolioMieten').textContent = formatCurrency(totalRent);
            document.getElementById('portfolioRendite').textContent = avgYield.toFixed(2) + '%';
            document.getElementById('portfolioCashflow').textContent = formatCurrency(monthlyCashflow);

            // Liste der Immobilien
            listContainer.innerHTML = immobilien.map(i => {
                const yield_ = ((i.miete * 12) / i.kaufpreis) * 100;
                const transactions = immobilienTransactions.filter(t => t.immobilienId === i.id);
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const cashflow = income - expense;

                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-description">${i.name}</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem;">
                                ${i.adresse} ‚Ä¢ ${i.wohneinheiten} WE ‚Ä¢ Rendite: ${yield_.toFixed(2)}%
                            </div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">
                                Soll-Miete: ${formatCurrency(i.miete)}/Monat ‚Ä¢ Netto-Cashflow: ${formatCurrency(cashflow)}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: 700;">
                                ${formatCurrency(i.kaufpreis)}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                Kaufdatum: ${formatDate(i.kaufdatum)}
                            </div>
                        </div>
                        <div class="transaction-actions">
                            <button class="btn-icon" onclick="editImmobilie(${i.id})" title="Bearbeiten">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="deleteImmobilie(${i.id})" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function editImmobilie(id) {
            const immobilien = await getAllFromStore('immobilien');
            const immo = immobilien.find(i => i.id === id);
            
            if (!immo) return;

            editingImmobilieId = id;
            document.getElementById('immobilienName').value = immo.name;
            document.getElementById('immobilienAdresse').value = immo.adresse;
            document.getElementById('immobilienKaufpreis').value = immo.kaufpreis;
            document.getElementById('immobilienMiete').value = immo.miete;
            document.getElementById('immobilienWohneinheiten').value = immo.wohneinheiten;
            document.getElementById('immobilienKaufdatum').value = immo.kaufdatum;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast('Immobilie wird bearbeitet', 'success');
        }

        async function deleteImmobilie(id) {
            if (!confirm('M√∂chten Sie diese Immobilie wirklich l√∂schen? Alle zugeh√∂rigen Transaktionen bleiben erhalten.')) return;

            try {
                await deleteFromStore('immobilien', id);
                showToast('Immobilie gel√∂scht', 'success');
                loadImmobilien();
                updateImmobilienSelects();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        // Kreditrechner (NEU)
        function calculateLoan() {
            const kaufpreis = parseFloat(document.getElementById('calcKaufpreis').value) || 0;
            const eigenkapital = parseFloat(document.getElementById('calcEigenkapital').value) || 0;
            const zinssatz = parseFloat(document.getElementById('calcZinssatz').value) || 0;
            const laufzeit = parseInt(document.getElementById('calcLaufzeit').value) || 0;
            const miete = parseFloat(document.getElementById('calcMiete').value) || 0;
            const kfw = parseFloat(document.getElementById('calcKfW').value) || 0;

            if (kaufpreis === 0 || laufzeit === 0) {
                document.getElementById('loanResult').innerHTML = `
                    <div><strong>Ergebnis:</strong> Bitte f√ºllen Sie alle Pflichtfelder aus.</div>
                `;
                return;
            }

            const darlehensbetrag = kaufpreis - eigenkapital - kfw;
            const monatlicherZins = zinssatz / 100 / 12;
            const anzahlRaten = laufzeit * 12;

            let monatlicheRate = 0;
            if (monatlicherZins > 0) {
                monatlicheRate = darlehensbetrag * (monatlicherZins * Math.pow(1 + monatlicherZins, anzahlRaten)) / (Math.pow(1 + monatlicherZins, anzahlRaten) - 1);
            } else {
                monatlicheRate = darlehensbetrag / anzahlRaten;
            }

            const gesamtkosten = monatlicheRate * anzahlRaten;
            const gesamtzinsen = gesamtkosten - darlehensbetrag;
            const cashflow = miete - monatlicheRate;
            const eigenkapitalquote = (eigenkapital / kaufpreis) * 100;

            let cashflowClass = cashflow >= 0 ? 'success' : 'danger';

            document.getElementById('loanResult').innerHTML = `
                <div>
                    <strong>üí∞ Darlehensbetrag:</strong> ${formatCurrency(darlehensbetrag)}<br>
                    <strong>üìÖ Monatliche Rate:</strong> ${formatCurrency(monatlicheRate)}<br>
                    <strong>üíµ Gesamtkosten:</strong> ${formatCurrency(gesamtkosten)} (davon Zinsen: ${formatCurrency(gesamtzinsen)})<br>
                    <strong>üìä Eigenkapitalquote:</strong> ${eigenkapitalquote.toFixed(1)}%<br>
                    ${kfw > 0 ? `<strong>üè¶ KfW-F√∂rderung:</strong> ${formatCurrency(kfw)}<br>` : ''}
                    ${miete > 0 ? `<strong class="alert-${cashflowClass}">üí∏ Monatlicher Cashflow:</strong> ${formatCurrency(cashflow)} (Miete ${formatCurrency(miete)} - Rate ${formatCurrency(monatlicheRate)})` : ''}
                </div>
            `;
        }

        async function addImmobilienTransaction(event) {
            event.preventDefault();

            const transaction = {
                immobilienId: parseInt(document.getElementById('immobilienSelect').value),
                type: document.getElementById('immobilienTransactionType').value,
                category: document.getElementById('immobilienCategory').value,
                amount: parseFloat(document.getElementById('immobilienAmount').value),
                date: document.getElementById('immobilienTransactionDate').value,
                description: document.getElementById('immobilienDescription').value,
                timestamp: new Date().getTime()
            };

            try {
                await addToStore('immobilienTransactions', transaction);
                showToast('Transaktion erfasst!', 'success');
                document.getElementById('immobilienTransactionForm').reset();
                document.getElementById('immobilienTransactionDate').valueAsDate = new Date();
                loadImmobilien();
                loadImmobilienTransactions();
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
                console.error(error);
            }
        }

        async function loadImmobilienTransactions() {
            const transactions = await getAllFromStore('immobilienTransactions');
            const immobilien = await getAllFromStore('immobilien');
            const container = document.getElementById('immobilienTransactionsList');

            if (transactions.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Noch keine Transaktionen erfasst.</p></div>';
                return;
            }

            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = transactions.map(t => {
                const immo = immobilien.find(i => i.id === t.immobilienId);
                const immoName = immo ? immo.name : 'Gel√∂scht';

                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <span class="transaction-category">${t.category}</span>
                            <div class="transaction-description">${t.description}</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">Immobilie: ${immoName}</div>
                            <div class="transaction-date">${formatDate(t.date)}</div>
                        </div>
                        <div class="transaction-amount ${t.type}">
                            ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                        </div>
                        <div class="transaction-actions">
                            <button class="btn-icon" onclick="deleteImmobilienTransaction(${t.id})" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteImmobilienTransaction(id) {
            if (!confirm('M√∂chten Sie diese Transaktion l√∂schen?')) return;

            try {
                await deleteFromStore('immobilienTransactions', id);
                showToast('Transaktion gel√∂scht', 'success');
                loadImmobilien();
                loadImmobilienTransactions();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        function updateImmobilienCategories() {
            const type = document.getElementById('immobilienTransactionType').value;
            const categorySelect = document.getElementById('immobilienCategory');

            if (type === 'income') {
                categorySelect.innerHTML = `
                    <option value="Miete">üí∞ Mieteinnahme</option>
                    <option value="Nebenkosten-Nachzahlung">üí∏ Nebenkosten-Nachzahlung</option>
                    <option value="Kaution">üîí Kaution</option>
                `;
            } else {
                categorySelect.innerHTML = `
                    <option value="Reparatur">üîß Reparatur</option>
                    <option value="Instandhaltung">üõ†Ô∏è Instandhaltung</option>
                    <option value="Verwaltung">üìã Verwaltungskosten</option>
                    <option value="Grundsteuer">üèõÔ∏è Grundsteuer</option>
                    <option value="Versicherung">üõ°Ô∏è Versicherung</option>
                    <option value="Nebenkosten">üí° Nebenkosten</option>
                    <option value="Sonstiges">üì¶ Sonstiges</option>
                `;
            }
        }

        async function updateImmobilienSelects() {
            const immobilien = await getAllFromStore('immobilien');
            
            const selects = ['immobilienSelect', 'filterImmobilie'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const isFilter = selectId === 'filterImmobilie';
                    const currentValue = select.value;
                    
                    select.innerHTML = isFilter ? '<option value="all">Alle Immobilien</option>' : '<option value="">-- Bitte w√§hlen --</option>';
                    
                    immobilien.forEach(immo => {
                        const option = document.createElement('option');
                        option.value = immo.id;
                        option.textContent = immo.name;
                        select.appendChild(option);
                    });
                    
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        async function filterImmobilienTransactions() {
    const typeFilter = document.getElementById('filterImmobilienType').value;
    const immobilieFilter = document.getElementById('filterImmobilie').value;
    
    let transactions = await getAllFromStore('immobilienTransactions');
    const immobilien = await getAllFromStore('immobilien');
    
    // Typ-Filter
    if (typeFilter !== 'all') {
        transactions = transactions.filter(t => t.type === typeFilter);
    }
    
    // Immobilie-Filter
    if (immobilieFilter !== 'all') {
        transactions = transactions.filter(t => t.immobilienId === parseInt(immobilieFilter));
    }
    
    // Sortieren
    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    const container = document.getElementById('immobilienTransactionsList');
    
    if (transactions.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Keine Transaktionen gefunden.</p></div>';
        return;
    }
    
    // Rendern
    container.innerHTML = transactions.map(t => {
        const immo = immobilien.find(i => i.id === t.immobilienId);
        const immoName = immo ? immo.name : 'Gel√∂scht';
        
        return `
            <div class="transaction-item">
                <div class="transaction-info">
                    <span class="transaction-category">${t.category}</span>
                    <div class="transaction-description">${t.description}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">Immobilie: ${immoName}</div>
                    <div class="transaction-date">${formatDate(t.date)}</div>
                </div>
                <div class="transaction-amount ${t.type}">
                    ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                </div>
                <div class="transaction-actions">
                    <button class="btn-icon" onclick="deleteImmobilienTransaction(${t.id})" title="L√∂schen">üóëÔ∏è</button>
                </div>
            </div>
        `;
    }).join('');
}

        // ==================== INVESTMENTS ====================
        async function addInvestment(event) {
            event.preventDefault();

            const investment = {
                type: document.getElementById('investmentType').value,
                name: document.getElementById('investmentName').value,
                isin: document.getElementById('investmentISIN').value,
                quantity: parseFloat(document.getElementById('investmentQuantity').value),
                buyPrice: parseFloat(document.getElementById('investmentBuyPrice').value),
                currentPrice: parseFloat(document.getElementById('investmentBuyPrice').value),
                buyDate: document.getElementById('investmentBuyDate').value,
                broker: document.getElementById('investmentBroker').value,
                fees: parseFloat(document.getElementById('investmentFees').value),
                timestamp: new Date().getTime()
            };

            try {
                if (editingInvestmentId) {
                    investment.id = editingInvestmentId;
                    await updateInStore('investments', investment);
                    showToast('Investment aktualisiert!', 'success');
                    editingInvestmentId = null;
                } else {
                    await addToStore('investments', investment);
                    showToast('Investment hinzugef√ºgt!', 'success');
                }
                document.getElementById('investmentForm').reset();
                document.getElementById('investmentBuyDate').valueAsDate = new Date();
                loadInvestments();
                updateInvestmentSelects();
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
                console.error(error);
            }
        }

        async function loadInvestments() {
            const investments = await getAllFromStore('investments');
            const dividends = await getAllFromStore('dividends');
            const container = document.getElementById('investmentsList');

            if (investments.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Noch keine Investments erfasst.</p></div>';
                updatePortfolioStats([]);
                return;
            }

            updatePortfolioStats(investments);

            container.innerHTML = investments.map(inv => {
                const invested = (inv.quantity * inv.buyPrice) + inv.fees;
                const currentValue = inv.quantity * inv.currentPrice;
                const profit = currentValue - invested;
                const performance = ((profit / invested) * 100);

                const invDividends = dividends.filter(d => d.investmentId === inv.id);
                const totalDividends = invDividends.reduce((sum, d) => sum + d.amount, 0);

                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-description">${inv.name}</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem;">
                                ${inv.type} ‚Ä¢ ${inv.isin || 'Kein ISIN'} ‚Ä¢ ${inv.quantity} Stk. ‚Ä¢ ${inv.broker || 'Kein Broker'}
                            </div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">
                                Kaufpreis: ${formatCurrency(inv.buyPrice)} ‚Ä¢ Aktuell: ${formatCurrency(inv.currentPrice)}
                                ${totalDividends > 0 ? ` ‚Ä¢ Dividenden: ${formatCurrency(totalDividends)}` : ''}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: 700;">
                                ${formatCurrency(currentValue)}
                            </div>
                            <div style="font-size: 0.9rem; font-weight: 600; color: ${profit >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}">
                                ${profit >= 0 ? '+' : ''}${formatCurrency(profit)} (${performance >= 0 ? '+' : ''}${performance.toFixed(2)}%)
                            </div>
                        </div>
                        <div class="transaction-actions">
                            <button class="btn-icon" onclick="editInvestment(${inv.id})" title="Bearbeiten">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="deleteInvestment(${inv.id})" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            loadAllocationChart(investments);
            loadPortfolioPerformanceChart(investments, dividends);
        }

        async function updatePortfolioStats(investments) {
            const dividends = await getAllFromStore('dividends');
            
            let totalInvested = 0;
            let totalValue = 0;

            investments.forEach(inv => {
                totalInvested += (inv.quantity * inv.buyPrice) + inv.fees;
                totalValue += inv.quantity * inv.currentPrice;
            });

            const profit = totalValue - totalInvested;
            const performance = totalInvested > 0 ? ((profit / totalInvested) * 100) : 0;

            const currentYear = new Date().getFullYear();
            const yearlyDividends = dividends
                .filter(d => new Date(d.date).getFullYear() === currentYear)
                .reduce((sum, d) => sum + d.amount, 0);

            document.getElementById('portfolioValue').textContent = formatCurrency(totalValue);
            document.getElementById('portfolioInvested').textContent = formatCurrency(totalInvested);
            document.getElementById('portfolioProfit').textContent = formatCurrency(profit);
            document.getElementById('portfolioPerformance').textContent = (performance >= 0 ? '+' : '') + performance.toFixed(2) + '%';
            document.getElementById('portfolioDividends').textContent = formatCurrency(yearlyDividends);
            document.getElementById('portfolioPositions').textContent = investments.length;

            const profitEl = document.getElementById('portfolioProfit');
            const performanceEl = document.getElementById('portfolioPerformance');
            
            if (profit >= 0) {
                profitEl.classList.add('positive');
                profitEl.classList.remove('negative');
                performanceEl.classList.add('positive');
                performanceEl.classList.remove('negative');
            } else {
                profitEl.classList.add('negative');
                profitEl.classList.remove('positive');
                performanceEl.classList.add('negative');
                performanceEl.classList.remove('positive');
            }
        }

        async function loadAllocationChart(investments) {
            const typeTotals = {};
            investments.forEach(inv => {
                const value = inv.quantity * inv.currentPrice;
                typeTotals[inv.type] = (typeTotals[inv.type] || 0) + value;
            });

            const ctx = document.getElementById('allocationChart');
            if (!ctx) return;

            if (allocationChart) allocationChart.destroy();

            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#f1f5f9' : '#0f172a';

            allocationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(typeTotals),
                    datasets: [{
                        data: Object.values(typeTotals),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${formatCurrency(context.parsed)}`
                            }
                        }
                    }
                }
            });
        }

        async function loadPortfolioPerformanceChart(investments, dividends) {
            // Vereinfachte Darstellung - gruppiert nach Kaufdatum
            const performanceData = {};

            investments.forEach(inv => {
                const date = inv.buyDate;
                if (!performanceData[date]) {
                    performanceData[date] = { invested: 0, current: 0 };
                }
                performanceData[date].invested += (inv.quantity * inv.buyPrice) + inv.fees;
                performanceData[date].current += inv.quantity * inv.currentPrice;
            });

            const sortedDates = Object.keys(performanceData).sort();
            let cumulativeInvested = 0;
            let cumulativeCurrent = 0;

            const chartData = sortedDates.map(date => {
                cumulativeInvested += performanceData[date].invested;
                cumulativeCurrent += performanceData[date].current;
                return {
                    date: date,
                    invested: cumulativeInvested,
                    current: cumulativeCurrent
                };
            });

            const ctx = document.getElementById('portfolioPerformanceChart');
            if (!ctx) return;

            if (portfolioPerformanceChart) portfolioPerformanceChart.destroy();

            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#f1f5f9' : '#0f172a';
            const gridColor = isDark ? '#475569' : '#cbd5e1';

            portfolioPerformanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => formatDate(d.date)),
                    datasets: [
                        {
                            label: 'Investiert',
                            data: chartData.map(d => d.invested),
                            borderColor: '#94a3b8',
                            tension: 0.4
                        },
                        {
                            label: 'Aktueller Wert',
                            data: chartData.map(d => d.current),
                            borderColor: '#10b981',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: textColor,
                                callback: (value) => formatCurrency(value)
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function editInvestment(id) {
            const investments = await getAllFromStore('investments');
            const inv = investments.find(i => i.id === id);
            
            if (!inv) return;

            editingInvestmentId = id;
            document.getElementById('investmentType').value = inv.type;
            document.getElementById('investmentName').value = inv.name;
            document.getElementById('investmentISIN').value = inv.isin;
            document.getElementById('investmentQuantity').value = inv.quantity;
            document.getElementById('investmentBuyPrice').value = inv.buyPrice;
            document.getElementById('investmentBuyDate').value = inv.buyDate;
            document.getElementById('investmentBroker').value = inv.broker;
            document.getElementById('investmentFees').value = inv.fees;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast('Investment wird bearbeitet', 'success');
        }

        async function deleteInvestment(id) {
            if (!confirm('M√∂chten Sie dieses Investment l√∂schen?')) return;

            try {
                await deleteFromStore('investments', id);
                showToast('Investment gel√∂scht', 'success');
                loadInvestments();
                updateInvestmentSelects();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        async function updatePrice(event) {
            event.preventDefault();

            const investmentId = parseInt(document.getElementById('priceUpdateSelect').value);
            const newPrice = parseFloat(document.getElementById('currentPrice').value);

            const investments = await getAllFromStore('investments');
            const investment = investments.find(i => i.id === investmentId);

            if (!investment) return;

            investment.currentPrice = newPrice;

            try {
                await updateInStore('investments', investment);
                showToast('Kurs aktualisiert!', 'success');
                document.getElementById('priceUpdateForm').reset();
                loadInvestments();
            } catch (error) {
                showToast('Fehler beim Aktualisieren', 'error');
                console.error(error);
            }
        }

        async function addDividend(event) {
            event.preventDefault();

            const dividend = {
                investmentId: parseInt(document.getElementById('dividendInvestmentSelect').value),
                amount: parseFloat(document.getElementById('dividendAmount').value),
                date: document.getElementById('dividendDate').value,
                description: document.getElementById('dividendDescription').value,
                timestamp: new Date().getTime()
            };

            try {
                await addToStore('dividends', dividend);
                showToast('Dividende erfasst!', 'success');
                document.getElementById('dividendForm').reset();
                document.getElementById('dividendDate').valueAsDate = new Date();
                loadDividends();
                loadInvestments();
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
                console.error(error);
            }
        }

        async function loadDividends() {
            const dividends = await getAllFromStore('dividends');
            const investments = await getAllFromStore('investments');
            const container = document.getElementById('dividendsList');

            if (dividends.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Noch keine Dividenden erfasst.</p></div>';
                return;
            }

            dividends.sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = dividends.map(d => {
                const investment = investments.find(i => i.id === d.investmentId);
                const invName = investment ? investment.name : 'Gel√∂scht';

                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-description">${invName}</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">
                                ${d.description || 'Dividende'}
                            </div>
                            <div class="transaction-date">${formatDate(d.date)}</div>
                        </div>
                        <div class="transaction-amount income">
                            +${formatCurrency(d.amount)}
                        </div>
                        <div class="transaction-actions">
                            <button class="btn-icon" onclick="deleteDividend(${d.id})" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteDividend(id) {
            if (!confirm('M√∂chten Sie diese Dividende l√∂schen?')) return;

            try {
                await deleteFromStore('dividends', id);
                showToast('Dividende gel√∂scht', 'success');
                loadDividends();
                loadInvestments();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        async function updateInvestmentSelects() {
            const investments = await getAllFromStore('investments');
            
            const selects = ['priceUpdateSelect', 'dividendInvestmentSelect'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    
                    select.innerHTML = '<option value="">-- Bitte w√§hlen --</option>';
                    
                    investments.forEach(inv => {
                        const option = document.createElement('option');
                        option.value = inv.id;
                        option.textContent = inv.name;
                        select.appendChild(option);
                    });
                    
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        function filterInvestments() {
            // Vereinfachte Implementierung
            loadInvestments();
        }

        // ==================== TAXES (STEUER-REPORT) ====================
        async function loadTaxReport() {
            const currentYear = new Date().getFullYear();
            const taxYearSelect = document.getElementById('taxYear');
            
            // Bef√ºlle Jahr-Auswahl
            if (taxYearSelect.options.length === 0) {
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    taxYearSelect.appendChild(option);
                }
            }

            const selectedYear = parseInt(taxYearSelect.value) || currentYear;

            // Lade Immobilien-Daten
            const immobilien = await getAllFromStore('immobilien');
            const immobilienTransactions = await getAllFromStore('immobilienTransactions');

            const yearTransactions = immobilienTransactions.filter(t => 
                new Date(t.date).getFullYear() === selectedYear
            );

            const rentalIncome = yearTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const rentalExpenses = yearTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('taxRentalIncome').textContent = formatCurrency(rentalIncome);
            document.getElementById('taxRentalExpenses').textContent = formatCurrency(rentalExpenses);

            // Details nach Immobilie
            const rentalDetails = document.getElementById('taxRentalDetails');
            rentalDetails.innerHTML = immobilien.map(immo => {
                const immoIncome = yearTransactions
                    .filter(t => t.immobilienId === immo.id && t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                return `<div style="padding: 0.5rem; border-left: 3px solid var(--accent-success); margin-bottom: 0.5rem;">
                    <strong>${immo.name}:</strong> ${formatCurrency(immoIncome)}
                </div>`;
            }).join('');

            const expenseDetails = document.getElementById('taxRentalExpensesDetails');
            expenseDetails.innerHTML = immobilien.map(immo => {
                const immoExpenses = yearTransactions
                    .filter(t => t.immobilienId === immo.id && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                return `<div style="padding: 0.5rem; border-left: 3px solid var(--accent-danger); margin-bottom: 0.5rem;">
                    <strong>${immo.name}:</strong> ${formatCurrency(immoExpenses)}
                </div>`;
            }).join('');

            // Kapitalertr√§ge (vereinfacht - nur Dividenden)
            const dividends = await getAllFromStore('dividends');
            const yearDividends = dividends
                .filter(d => new Date(d.date).getFullYear() === selectedYear)
                .reduce((sum, d) => sum + d.amount, 0);

            document.getElementById('taxDividends').textContent = formatCurrency(yearDividends);
            document.getElementById('taxCapitalGains').textContent = '0,00 ‚Ç¨ (noch nicht implementiert)';

            // Zusammenfassung
            const netRental = rentalIncome - rentalExpenses;
            const summaryHtml = `
                <strong>Netto-Mieteinnahmen:</strong> ${formatCurrency(netRental)}<br>
                <strong>Dividenden:</strong> ${formatCurrency(yearDividends)}<br>
                <strong>Gesamt steuerpflichtige Eink√ºnfte:</strong> ${formatCurrency(netRental + yearDividends)}
            `;
            document.getElementById('taxSummary').innerHTML = summaryHtml;
        }

        function generateTaxReport() {
            showToast('PDF-Export wird vorbereitet... (Feature in Entwicklung)', 'info');
            // Hier k√∂nnte eine PDF-Generierung mit jsPDF implementiert werden
        }

        // ==================== CSV IMPORT ====================
        function previewCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showToast('CSV-Datei ist leer oder ung√ºltig', 'error');
                    return;
                }

                // Erste Zeile als Header
                const headers = lines[0].split(';').map(h => h.trim());
                
                // Erkennung der Spalten
                const dateCol = headers.findIndex(h => h.toLowerCase().includes('datum') || h.toLowerCase().includes('date'));
                const amountCol = headers.findIndex(h => h.toLowerCase().includes('betrag') || h.toLowerCase().includes('amount'));
                const descCol = headers.findIndex(h => h.toLowerCase().includes('beschreibung') || h.toLowerCase().includes('text') || h.toLowerCase().includes('verwendung'));

                if (dateCol === -1 || amountCol === -1) {
                    showToast('CSV-Spalten nicht erkannt. Bitte pr√ºfen Sie das Format.', 'error');
                    return;
                }

                csvImportData = [];

                for (let i = 1; i < Math.min(lines.length, 11); i++) {
                    const cols = lines[i].split(';').map(c => c.trim());
                    
                    if (cols.length > Math.max(dateCol, amountCol)) {
                        const dateStr = cols[dateCol];
                        let amount = parseFloat(cols[amountCol].replace(',', '.').replace(/[^\d.-]/g, ''));
                        const description = descCol !== -1 ? cols[descCol] : 'Import';

                        // Datum parsen
                        let date = null;
                        if (dateStr.includes('.')) {
                            const parts = dateStr.split('.');
                            if (parts.length === 3) {
                                date = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            }
                        } else if (dateStr.includes('-')) {
                            date = dateStr;
                        }

                        if (date && !isNaN(amount)) {
                            csvImportData.push({
                                date: date,
                                amount: Math.abs(amount),
                                description: description,
                                type: amount >= 0 ? 'income' : 'expense',
                                category: 'Sonstiges',
                                account: '',
                                note: 'CSV Import',
                                tags: ['csv-import'],
                                isRecurring: false,
                                timestamp: new Date().getTime()
                            });
                        }
                    }
                }

                const previewContainer = document.getElementById('csvPreview');
                previewContainer.innerHTML = `
                    <div class="alert alert-success">
                        <strong>${csvImportData.length}</strong> Transaktionen gefunden (Vorschau erste 10 Zeilen)
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${csvImportData.map(t => `
                            <div class="transaction-item">
                                <div class="transaction-info">
                                    <div class="transaction-description">${t.description}</div>
                                    <div class="transaction-date">${formatDate(t.date)}</div>
                                </div>
                                <div class="transaction-amount ${t.type}">
                                    ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                document.getElementById('importCSVBtn').style.display = 'block';
            };
            reader.readAsText(file, 'UTF-8');
        }

        async function importCSV() {
            if (csvImportData.length === 0) {
                showToast('Keine Daten zum Importieren', 'error');
                return;
            }

            let count = 0;
            for (const transaction of csvImportData) {
                try {
                    await addToStore('transactions', transaction);
                    count++;
                } catch (error) {
                    console.error('Fehler beim Import:', error);
                }
            }

            showToast(`${count} Transaktionen importiert!`, 'success');
            closeModal('csvImportModal');
            csvImportData = [];
            document.getElementById('csvPreview').innerHTML = '';
            document.getElementById('importCSVBtn').style.display = 'none';
            document.getElementById('csvFile').value = '';
            
            loadTransactions();
            loadDashboard();
        }

        // ==================== DATA EXPORT/IMPORT ====================
        async function exportData() {
            try {
                const data = {
                    transactions: await getAllFromStore('transactions'),
                    recurring: await getAllFromStore('recurring'),
                    budgets: await getAllFromStore('budgets'),
                    goals: await getAllFromStore('goals'),
                    subscriptions: await getAllFromStore('subscriptions'),
                    categories: await getAllFromStore('categories'),
                    accounts: await getAllFromStore('accounts'),
                    templates: await getAllFromStore('templates'),
                    immobilien: await getAllFromStore('immobilien'),
                    immobilienTransactions: await getAllFromStore('immobilienTransactions'),
                    investments: await getAllFromStore('investments'),
                    dividends: await getAllFromStore('dividends'),
                    exportDate: new Date().toISOString(),
                    version: '3.0.0'
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `finance-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('Daten erfolgreich exportiert!', 'success');
            } catch (error) {
                showToast('Fehler beim Export', 'error');
                console.error(error);
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    if (!confirm('M√∂chten Sie die importierten Daten zu den bestehenden HINZUF√úGEN? (Abbrechen = Bestehende Daten werden ERSETZT)')) {
                        await clearAllData(false);
                    }

                    const stores = ['transactions', 'recurring', 'budgets', 'goals', 'subscriptions', 
                                  'categories', 'accounts', 'templates', 'immobilien', 'immobilienTransactions', 
                                  'investments', 'dividends'];

                    for (const storeName of stores) {
                        if (data[storeName]) {
                            for (const item of data[storeName]) {
                                delete item.id;
                                await addToStore(storeName, item);
                            }
                        }
                    }

                    showToast('Daten erfolgreich importiert!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } catch (error) {
                    showToast('Fehler beim Import - ung√ºltige Datei', 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        async function clearAllData(confirm = true) {
            if (confirm && !window.confirm('ACHTUNG: Alle Daten werden unwiderruflich gel√∂scht! Fortfahren?')) return;

            try {
                const stores = ['transactions', 'recurring', 'budgets', 'goals', 'subscriptions',
                              'categories', 'accounts', 'templates', 'immobilien', 'immobilienTransactions',
                              'investments', 'dividends'];
                
                for (const storeName of stores) {
                    const items = await getAllFromStore(storeName);
                    for (const item of items) {
                        await deleteFromStore(storeName, item.id);
                    }
                }

                showToast('Alle Daten wurden gel√∂scht', 'success');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
                console.error(error);
            }
        }

        function createBackup() {
            exportData();
            closeModal('backupModal');
        }

        function restoreBackup(event) {
            importData(event);
            closeModal('backupModal');
        }

        async function exportImmobilienCSV() {
            try {
                const immobilien = await getAllFromStore('immobilien');
                const transactions = await getAllFromStore('immobilienTransactions');

                if (immobilien.length === 0) {
                    showToast('Keine Immobilien zum Exportieren vorhanden', 'error');
                    return;
                }

                let csv = 'Immobilie;Adresse;Kaufpreis;Monatliche Miete;Wohneinheiten;Kaufdatum;Rendite;Einnahmen (gesamt);Ausgaben (gesamt);Netto-Cashflow\n';

                immobilien.forEach(immo => {
                    const immoTransactions = transactions.filter(t => t.immobilienId === immo.id);
                    const einnahmen = immoTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                    const ausgaben = immoTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                    const cashflow = einnahmen - ausgaben;
                    const rendite = ((immo.miete * 12) / immo.kaufpreis) * 100;

                    csv += `${immo.name};${immo.adresse};${immo.kaufpreis};${immo.miete};${immo.wohneinheiten};${immo.kaufdatum};${rendite.toFixed(2)}%;${einnahmen};${ausgaben};${cashflow}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `immobilien-report-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('Immobilien-Report erfolgreich exportiert!', 'success');
            } catch (error) {
                showToast('Fehler beim Export', 'error');
                console.error(error);
            }
        }

        // ==================== INITIALIZATION ====================
        async function init() {
            try {
                await initDB();

                // Initialize default data
                await initializeCategories();
                await initializeAccounts();

                // Theme laden
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.body.setAttribute('data-theme', savedTheme);
                document.querySelector('.theme-toggle').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';

                // Datum-Felder initialisieren
                const today = new Date().toISOString().split('T')[0];
                const dateFields = [
                    'transactionDate', 'recurringStartDate', 'immobilienKaufdatum',
                    'immobilienTransactionDate', 'investmentBuyDate', 'dividendDate'
                ];
                dateFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = today;
                });

                // Selects bef√ºllen
                await populateAllCategorySelects();
                await populateAllAccountSelects();
                await loadAccountSelector();

                // Dashboard initial laden
                await loadDashboard();
                
                // Automatisch f√§llige wiederkehrende Transaktionen generieren (im Hintergrund)
                setTimeout(async () => {
                    const recurring = await getAllFromStore('recurring');
                    const activeRecurring = recurring.filter(r => r.active);
                    if (activeRecurring.length > 0) {
                        // Stille Generierung im Hintergrund
                        await generateAllRecurringTransactions();
                    }
                }, 2000);

                console.log('‚úÖ Finance Tracker Pro v3.0.0 Ultimate Edition erfolgreich geladen!');
                showToast('Willkommen zur√ºck! üí∞', 'success');
            } catch (error) {
                console.error('‚ùå Initialisierungsfehler:', error);
                showToast('Fehler beim Laden der Anwendung', 'error');
            }
        }

        async function generateAllRecurringTransactions() {
            const recurring = await getAllFromStore('recurring');
            const activeRecurring = recurring.filter(r => r.active);
            const transactions = await getAllFromStore('transactions');

            let count = 0;

            for (const item of activeRecurring) {
                const instances = await calculateRecurringInstances(item);
                
                for (const inst of instances) {
                    const isDuplicate = transactions.some(t => 
                        t.isRecurring && 
                        t.recurringId === item.id && 
                        t.date === inst.date
                    );

                    if (!isDuplicate) {
                        const transaction = {
                            type: item.type,
                            amount: item.amount,
                            category: item.category,
                            date: inst.date,
                            description: item.description,
                            account: item.account,
                            note: '',
                            tags: [],
                            isRecurring: true,
                            recurringId: item.id,
                            timestamp: new Date().getTime()
                        };

                        await addToStore('transactions', transaction);
                        count++;
                    }
                }

                if (count > 0) {
                    item.lastGeneratedDate = dateToString(new Date());
                    await updateInStore('recurring', item);
                }
            }

            if (count > 0) {
                console.log(`‚úÖ ${count} wiederkehrende Transaktionen automatisch generiert`);
            }
        }

        // App starten
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('‚úÖ PWA Service Worker registriert!', reg))
                    .catch(err => console.log('‚ùå Service Worker Fehler:', err));
            });
        }
    </script>
</body>
</html>






